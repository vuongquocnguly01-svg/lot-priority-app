<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng B·∫£o Tr√¨ & S·∫£n L∆∞·ª£ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- GIAO DI·ªÜN C∆† B·∫¢N --- */
        :root {
            --primary: #007bff; --success: #28a745; --danger: #dc3545;
            --text: #333; --bg: #f4f6f9; --border: #dee2e6;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }

        /* --- TOAST NOTIFICATION --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { min-width: 250px; margin-bottom: 10px; padding: 15px; border-radius: 5px; color: white; opacity: 0.9; box-shadow: 0 2px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- KHUNG ƒêƒÇNG NH·∫¨P --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 8px; width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }

        /* --- GIAO DI·ªÜN CH√çNH --- */
        #main-app { display: none; width: 100%; max-width: 1380px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; }

        /* --- N√öT B·∫§M & INPUT --- */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* --- TABLE STYLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        th { background: var(--primary); color: white; text-transform: uppercase; font-size: 13px; }

        .furnace-row-header { background-color: #f9fbfd; font-weight: bold; border-right: 2px solid #ddd; }

        /* --- PH·∫¶N B·∫¢O TR√å --- */
        .maintenance-section { margin-top: 10px; }
        .maintenance-controls { display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .maintenance-controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; font-weight: bold; }
        .task-cell { display: flex; align-items: center; gap: 8px; }
        .task-cell input[type="date"] { border: 1px solid #ddd; padding: 3px; border-radius: 4px; font-size: 12px; width: 110px; transition: 0.2s; }
        .hidden-date { opacity: 0; pointer-events: none; width: 0 !important; padding: 0 !important; border: none !important; }

        /* --- NOTE INPUT LINH ƒê·ªòNG --- */
        .note-input {
            min-width: 150px;
            width: auto;
            max-width: 100%;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            transition: width 0.2s;
        }

        /* --- PH·∫¶N S·∫¢N L∆Ø·ª¢NG --- */
        .production-section { margin-top: 40px; border-top: 2px dashed #007bff; padding-top: 20px; }
        .prod-input-group input, .prod-input-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        .config-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        .config-row label { font-weight: bold; font-size: 13px; }
        .config-row input { width: 80px; text-align: center; }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; text-align: right; }
        .stats-table th { background: #e9f7ef; font-weight: bold; text-align: center; }
        .stats-table .person-col { text-align: left; font-weight: bold; background: #f8f9fa; }
        .stats-table .total-col { background: #fff3cd; font-weight: bold; color: #856404; }

        .grand-total-footer { background-color: #ffeb3b !important; color: #856404; font-weight: bold; font-size: 15px; border-top: 2px solid #aaa; }

        .color-UC { background-color: #e6f7ff !important; }
        .color-C { background-color: #f0fff0 !important; }
        .color-R { background-color: #fff4e6 !important; }
        .color-T1 { background-color: #f7e6ff !important; }
        .color-default { background-color: #f5f5f5 !important; }

        .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }

        /* CSS cho ph·∫ßn hi·ªÉn th·ªã l·ªói chi ti·∫øt */
        .error-log-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff5f5;
            border: 1px solid #dc3545;
            border-radius: 5px;
            display: none;
            max-height: 250px;
            overflow-y: auto;
            font-size: 13px;
            color: #721c24;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .error-log-item { border-bottom: 1px solid #f5c6cb; padding: 6px 0; }
        .error-log-item:last-child { border-bottom: none; }
        .error-display { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="login-overlay">
    <div class="login-box">
        <h2>ƒêƒÉng Nh·∫≠p</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button id="login-btn">V√ÄO H·ªÜ TH·ªêNG</button>
        <p id="login-msg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
    </div>
</div>

<div id="main-app">
    <header>
        <h1>QU·∫¢N L√ù B·∫¢O TR√å & S·∫¢N L∆Ø·ª¢NG</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-danger" id="logout-btn">ƒêƒÉng xu·∫•t</button>
        </div>
    </header>

    <div class="maintenance-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üõ† L·ªäCH S·ª¨ B·∫¢O TR√å</h2>
            <div class="maintenance-controls">
                <span>Xem d·ªØ li·ªáu:</span>
                <select id="viewMonth" onchange="changeViewDate()"></select>
                <select id="viewYear" onchange="changeViewDate()"></select>
                <button class="btn btn-outline" onclick="jumpToNow()">V·ªÅ hi·ªán t·∫°i</button>
            </div>
        </div>

        <div id="maintenanceError" class="error-display">
            C√≥ l·ªói t·∫£i d·ªØ li·ªáu.
            <button class="btn btn-danger" onclick="hardResetMaintenance()">Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</button>
        </div>

        <div id="maintenanceLoading" class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu b·∫£o tr√¨...</div>
        <div id="maintenanceContent" style="display: none;"></div>

        <div style="margin-bottom: 10px; margin-top: 10px;">
            <button id="add-furnace-btn" class="btn btn-success">‚ûï Th√™m L√≤ Nung</button>
            <button id="delete-furnace-btn" class="btn btn-danger">üóëÔ∏è X√≥a L√≤ Nung</button>

            <div id="add-furnace-dialog" style="display:none; margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 5px;">
                <input type="text" id="new-furnace-name" placeholder="T√™n l√≤ (VD: L√≤ 8)">
                <button id="save-new-furnace-btn" class="btn btn-primary">L∆∞u</button>
                <button id="cancel-add-furnace-btn" class="btn btn-danger">H·ªßy</button>
            </div>

            <div id="delete-furnace-dialog" style="display:none; margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #fff3cd; border-radius: 5px;">
                <select id="furnace-select-to-delete" style="padding: 5px;"></select>
                <input type="password" id="delete-password-input" placeholder="M·∫≠t kh·∫©u admin">
                <button id="confirm-delete-btn" class="btn btn-danger">X√°c nh·∫≠n X√≥a</button>
                <button id="cancel-delete-btn" class="btn btn-outline">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="production-section">
        <h2>üìà PH√ÇN T√çCH </h2>

        <div style="padding: 15px; border: 1px solid var(--primary); border-radius: 8px; background: #f0f8ff;">

            <p style="font-weight: bold; margin-bottom: 10px;">B∆∞·ªõc 1: T·∫£i File Excel D·ªØ Li·ªáu</p>
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex: 1; border: 1px dashed green; padding: 10px; border-radius: 5px; background: white;">
                    <label style="font-weight: bold; color: green;">File ƒê·∫ßu V√ÄO (IN):</label>
                    <input type="file" id="inputFileInput" onchange="handleFileSelection(event, 'IN')" multiple>
                    <div id="fileList_IN" style="font-size: 12px; margin-top: 5px; color: #555;">Ch∆∞a ch·ªçn file.</div>
                </div>
                <div style="flex: 1; border: 1px dashed blue; padding: 10px; border-radius: 5px; background: white;">
                    <label style="font-weight: bold; color: blue;">File ƒê·∫ßu RA (OUT):</label>
                    <input type="file" id="outputFileInput" onchange="handleFileSelection(event, 'OUT')" multiple>
                    <div id="fileList_OUT" style="font-size: 12px; margin-top: 5px; color: #555;">Ch∆∞a ch·ªçn file.</div>
                </div>
            </div>

            <div id="excelErrorLog" class="error-log-container"></div>
            <div id="excelError" style="color: var(--danger); margin-top: 10px; font-weight: bold;"></div>

            <div class="config-row">
                <span>C·∫•u h√¨nh c·ªôt (Excel):</span>
                <label>Ng√†y (A):</label> <input type="text" id="colDateInput" value="A">
                <label>C√¥ng ƒëo·∫°n (B):</label> <input type="text" id="colProcessInput" value="B">
                <label>S·∫£n l∆∞·ª£ng (H):</label> <input type="text" id="colProdInput" value="H">
                <label>Ng∆∞·ªùi (R):</label> <input type="text" id="colPersonInput" value="R">
                <label>D√≤ng Ti√™u ƒê·ªÅ:</label> <input type="number" id="headerRowInput" value="5" min="1" style="width: 50px;">
             </div>

            <hr style="margin: 20px 0; border-top: 1px solid #ccc;">

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="showSection('monthly')">üìä B√°o C√°o Th√°ng</button>
                <button class="btn btn-primary" onclick="showSection('daily')">üî• Hi·ªáu Su·∫•t L√≤ nung</button>
            </div>

            <div id="section-monthly">
                <h3>Ph√¢n T√≠ch T·ªïng H·ª£p Th√°ng</h3>
                <div class="prod-input-group" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <label>Th√°ng:</label>
                    <select id="prodMonth" style="width: 80px;"></select>
                    <select id="prodYear" style="width: 100px;"></select>

                    <label>Ng∆∞·ªùi:</label>
                    <select id="personSelect" style="width: 150px;">
                        <option value="all">-- T·∫•t C·∫£ --</option>
                    </select>

                    <button class="btn btn-success" onclick="calculateProduction()">üí∞ T√çNH T·ªîNG S·∫¢N L∆Ø·ª¢NG</button>
                    <button class="btn btn-primary" id="exportBtn" onclick="exportToExcel()" style="display: none;">Excel</button>
                    <button class="btn btn-primary" id="captureBtn" onclick="captureAndDownloadStats()" style="display: none;">üì∏ Ch·ª•p ·∫¢nh</button>
                </div>
                <div id="productionStatsContainer" style="display: none; margin-top: 20px;"></div>
            </div>

            <div id="section-daily" style="display: none;">
                <h3>Ph√¢n T√≠ch Hi·ªáu Su·∫•t L√≤ Nung</h3>

                <div class="config-row" style="background: #fff3cd;">
                    <span>C·∫•u h√¨nh:</span>
                    <label>Lo·∫°i h√†ng (Lot/Dami) - C·ªôt:</label> <input type="text" id="colTypeInput" value="D" placeholder="D">

                    <label>Keijo - C·ªôt:</label> <input type="text" id="colKeijoInput" value="C" placeholder="C">

                    <label>T√™n L√≤ - C·ªôt:</label> <input type="text" id="colFurnaceInput" value="F" placeholder="F">
                    <label>Ph·∫ø ph·∫©m - C·ªôt:</label> <input type="text" id="colScrapInput" value="J" placeholder="J">
                </div>

                <div class="prod-input-group" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="margin-right: 15px;">
                        <label style="font-weight:bold; color:var(--primary); display:block; font-size:12px;">1. Ch·ªçn Ng√†y:</label>
                        <input type="date" id="dailyDate">
                    </div>

                    <div style="margin-right: 15px;">
                        <label style="font-weight:bold; color:var(--primary); display:block; font-size:12px;">2. Ch·ªçn Ca:</label>
                        <select id="shiftSelect" style="padding: 8px; font-weight: bold;" onchange="updateShiftTimeInputs()">
                            <option value="DAY">‚òÄ Ca Ng√†y</option>
                            <option value="NIGHT">üåô Ca ƒê√™m</option>
                        </select>
                    </div>

                    <div style="display:flex; gap:5px; align-items:flex-end;">
                        <div>
                            <label style="font-size:12px; font-weight:bold;">T·ª´:</label>
                            <input type="time" id="customStartTime" value="07:00">
                        </div>
                        <div>
                            <label style="font-size:12px; font-weight:bold;">ƒê·∫øn:</label>
                            <input type="time" id="customEndTime" value="19:00">
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="calculateFurnaceEfficiency()" style="height: 36px; margin-top: 18px;">üî• T√çNH TO√ÅN</button>
                </div>

                <div style="margin-top: 10px; font-size: 13px; color: #666; font-style: italic;">
                    * üëÄüëÄüëÄüëÄüëÄ
                </div>

                <div id="dailyFurnaceContainer" style="margin-top: 20px;"></div>
            </div>

        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
   const firebaseConfig = {
     apiKey: "AIzaSyCn866gY_3OiB_VL0fUDMe3ZCdhYDRbIJ8",
     authDomain: "lot-priority-app-shared.firebaseapp.com",
     projectId: "lot-priority-app-shared",
     storageBucket: "lot-priority-app-shared.firebasestorage.app",
     messagingSenderId: "12749059268",
     appId: "1:12749059268:web:e1aa877135d8741461c591",
     measurementId: "G-DPNT9PZ61Y"
   };

    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1377130413708808272/BH7cEuL4lWI6C-FfhNGnl84kgZ_LnqWn8TVIY8uuesT69PzrXuxZ60Uv4Tm1TFMW9BdC";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let viewYear = new Date().getFullYear();
    let viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
    let maintenanceDataCache = {};

    let inputFiles = [];
    let outputFiles = [];
    let allInputData = [];
    let allOutputData = [];
    let processList = new Set();

    let ovenTemps = {};
    const FURNACES_COLLECTION = 'furnaces';
    let currentFurnaceList = [];

    const PROCESS_COLORS = {
        'UC': 'color-UC', 'C': 'color-C', 'R': 'color-R', 'T1': 'color-T1',
        'CLF': 'color-CLF', 'T2': 'color-T2', 'T3': 'color-T3', 'G1': 'color-G1', 'GH': 'color-GH',
    };
    function getColorClass(processName) {
        if (!processName) return 'color-default';
        const key = processName.toUpperCase().replace(/[^A-Z0-9]/g, '');
        return PROCESS_COLORS[key] || 'color-default';
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerText = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function sendDiscordNotification(message) {
        if(!DISCORD_WEBHOOK_URL) return;
        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: message })
        }).catch(console.error);
    }

    function getTargetSaturdays(year, month) {
        const dates = [];
        const date = new Date(year, month - 1, 1);
        let count = 0;
        while (date.getMonth() === (month - 1)) {
            if (date.getDay() === 6) {
                count++;
                if (count === 1 || count === 3) dates.push(new Date(date).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit'}));
            }
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }

    function calculateMaintenanceStats(data, year, month) {
        let stats = { vesinhCompleted: 0, profileCompleted: 0, totalOvens: currentFurnaceList.length };
        currentFurnaceList.forEach(ovenName => {
            const curTemp = ovenTemps[ovenName] || '850';
            if (safeGet(data, `ovens.${ovenName}.${curTemp}.V·ªá sinh.${year}.${month}.completed`)) stats.vesinhCompleted++;
            if (safeGet(data, `ovens.${ovenName}.${curTemp}.ƒêo Profile.${year}.${month}.completed`)) stats.profileCompleted++;
        });
        return stats;
    }

    // --- B√ÅO L·ªñI UI ---
    let detailedErrors = [];

    function clearErrors() {
        const log = document.getElementById('excelErrorLog');
        log.innerHTML = '';
        log.style.display = 'none';
        document.getElementById('excelError').innerText = '';
        detailedErrors = [];
    }

    function flushErrors() {
        if (detailedErrors.length === 0) return;
        const log = document.getElementById('excelErrorLog');
        log.style.display = 'block';

        let html = '';
        const limit = Math.min(detailedErrors.length, 20);
        for(let i=0; i<limit; i++) {
            html += `<div class="error-log-item">‚ö†Ô∏è ${detailedErrors[i]}</div>`;
        }
        if(detailedErrors.length > 20) {
            html += `<div class="error-log-item" style="font-weight:bold; color:black;">... v√† ${detailedErrors.length - 20} l·ªói kh√°c. (Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh C·ªôt!)</div>`;
        }
        log.innerHTML = html;
        showToast("Ph√°t hi·ªán l·ªói d·ªØ li·ªáu! Xem chi ti·∫øt b√™n d∆∞·ªõi.", "error");
    }

    function addError(msg) {
        detailedErrors.push(msg);
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            if (!sessionStorage.getItem('logged_in_session')) {
                const statsRef = db.collection('system_stats').doc('login_counter');
                statsRef.set({ count: firebase.firestore.FieldValue.increment(1) }, { merge: true })
                .then(() => statsRef.get())
                .then(doc => {
                    sendDiscordNotification(`üîî **TH√îNG B√ÅO ƒêƒÇNG NH·∫¨P**\nüë§ User: **${user.email}**\nüî¢ L∆∞·ª£t: **${doc.data().count}**`);
                    sessionStorage.setItem('logged_in_session', 'true');
                });
            }
            loadUserMaintSettings(user).then(() => {
               initProdDateControls();
               checkConveyorReminder();
               initApp();
            });
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            sessionStorage.removeItem('logged_in_session');
        }
    });

    function checkConveyorReminder() {
        const today = new Date();
        if (today.getDay() !== 5) return;
        const tmr = new Date(today); tmr.setDate(today.getDate() + 1);
        const week = Math.ceil(tmr.getDate() / 7);
        if (week === 1 || week === 3) {
            const key = today.toISOString().split('T')[0];
            if (localStorage.getItem('discord_conveyor_sent') !== key) {
                sendDiscordNotification(`‚ö†Ô∏è **NH·∫ÆC NH·ªû B·∫¢O TR√å:**\nNg√†y mai (Th·ª© 7 - Tu·∫ßn ${week}) l√† l·ªãch **ƒêo t·ªëc ƒë·ªô bƒÉng t·∫£i**.`);
                localStorage.setItem('discord_conveyor_sent', key);
            }
        }
    }

    async function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        const msgEl = document.getElementById('login-msg');
        msgEl.innerText = '';
        if (!u || !p) { msgEl.innerText = "‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin."; return; }
        try {
            await auth.signInWithEmailAndPassword(`${u}@lot-priority-app-shared.com`, p);
            showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!", "success");
        } catch (e) {
            msgEl.innerText = "‚ùå ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Ki·ªÉm tra l·∫°i.";
            showToast("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u", "error");
        }
    }
    function handleLogout() { auth.signOut(); showToast("ƒê√£ ƒëƒÉng xu·∫•t", "info"); }

    function initApp() {
        db.collection('maintenance').doc('schedules').onSnapshot(doc => {
            const docData = doc.exists ? doc.data() : {};
            maintenanceDataCache = docData;
            const defaultTemps = { 'L√≤ 1': '850', 'L√≤ 2': '850', 'L√≤ 3': '850', 'L√≤ 4': '850', 'L√≤ 5': '850', 'L√≤ 6': '850', 'L√≤ 7': '850' };
            ovenTemps = docData.ovenTemps ? { ...defaultTemps, ...docData.ovenTemps } : defaultTemps;
            if (!maintenanceDataCache.ovens) maintenanceDataCache.ovens = {};
            if (!maintenanceDataCache.dakuto) maintenanceDataCache.dakuto = {};
            renderMaintenanceUI(maintenanceDataCache);
        }, () => {
            document.getElementById('maintenanceError').style.display = 'block';
            document.getElementById('maintenanceLoading').style.display = 'none';
        });

        allInputData = []; allOutputData = [];
        document.getElementById('fileList_IN').innerHTML = '<span style="color:red;">Ch∆∞a ch·ªçn file.</span>';
        document.getElementById('fileList_OUT').innerHTML = '<span style="color:red;">Ch∆∞a ch·ªçn file.</span>';
        document.getElementById('dailyDate').valueAsDate = new Date();
    }

    async function loadUserMaintSettings(user) {
         try {
              const doc = await db.collection('user_settings').doc(user.uid).get();
              if (doc.exists && doc.data().maintView) {
                 viewMonth = doc.data().maintView.month || viewMonth;
                 viewYear = doc.data().maintView.year || viewYear;
              }
         } catch (e) {}
         initDateControls();
    }

    function initDateControls() {
        const selM = document.getElementById('viewMonth');
        const selY = document.getElementById('viewYear');
        selM.innerHTML = ''; for(let i=1; i<=12; i++) selM.innerHTML += `<option value="${String(i).padStart(2, '0')}">Th√°ng ${i}</option>`;
        selY.innerHTML = '';
        const currentY = new Date().getFullYear();
        for(let i = currentY - 1; i <= currentY + 50; i++) selY.innerHTML += `<option value="${i}">NƒÉm ${i}</option>`;
        selM.value = viewMonth; selY.value = viewYear;
    }

    function initProdDateControls() {
        const selM = document.getElementById('prodMonth');
        const selY = document.getElementById('prodYear');
        const currentY = new Date().getFullYear();
        const currentM = String(new Date().getMonth() + 1).padStart(2, '0');
        selM.innerHTML = ''; for(let i=1; i<=12; i++) selM.innerHTML += `<option value="${String(i).padStart(2, '0')}">T${i}</option>`;
        selY.innerHTML = ''; for(let i = 2024; i <= currentY + 10; i++) selY.innerHTML += `<option value="${i}">NƒÉm ${i}</option>`;
        selM.value = currentM; selY.value = currentY;
    }

    function jumpToNow() {
        viewYear = new Date().getFullYear();
        viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
        document.getElementById('viewMonth').value = viewMonth;
        document.getElementById('viewYear').value = viewYear;
        changeViewDate();
    }

    function changeViewDate() {
        viewMonth = document.getElementById('viewMonth').value;
        viewYear = document.getElementById('viewYear').value;
        const user = auth.currentUser;
        if (user) db.collection('user_settings').doc(user.uid).set({ maintView: { month: viewMonth, year: viewYear } }, { merge: true });
        if (Object.keys(maintenanceDataCache).length > 0) renderMaintenanceUI(maintenanceDataCache);
    }

    function safeGet(obj, path) { return path.split('.').reduce((acc, part) => acc && acc[part], obj); }

    function renderMaintenanceUI(data) {
        const container = document.getElementById('maintenanceContent');
        document.getElementById('maintenanceLoading').style.display = 'none';
        container.style.display = 'block';

        let html = `<table class="maintenance-table"><thead><tr>
            <th style="width: 100px;">Thi·∫øt b·ªã</th><th style="width: 100px;">Nhi·ªát ƒë·ªô</th>
            <th>V·ªá sinh (850 1T/L·∫¶N)</th><th>ƒêo Profile (3T/L·∫¶N)</th><th>Ghi ch√∫</th>
        </tr></thead><tbody>`;

        const sortedFurnaces = currentFurnaceList.slice().sort((a, b) => {
            const numA = parseInt(a.match(/(\d+)/)?.[0]);
            const numB = parseInt(b.match(/(\d+)/)?.[0]);
            if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
            return a.localeCompare(b);
        });

        sortedFurnaces.forEach(ovenName => {
            const curTemp = ovenTemps[ovenName] || '850';
            let pathVS = `ovens.${ovenName}.${curTemp}.V·ªá sinh.${viewYear}.${viewMonth}`;
            let itemVS = safeGet(data, pathVS) || { completed: false, date: null };
            let pathPF = `ovens.${ovenName}.${curTemp}.ƒêo Profile.${viewYear}.${viewMonth}`;
            let itemPF = safeGet(data, pathPF) || { completed: false, date: null };
            let pathNote = `ovens.${ovenName}.notes.${String(viewYear)}.${String(viewMonth).padStart(2,'0')}`;
            let noteContent = safeGet(data, pathNote) || "";

            html += `<tr>
                <td style="font-weight:bold; background:#f9f9f9;">${ovenName}</td>
                <td><select onchange="changeOvenTemp('${ovenName}', this.value)">
                    <option value="850" ${curTemp=='850'?'selected':''}>850¬∞C</option>
                    <option value="600" ${curTemp=='600'?'selected':''}>600¬∞C</option>
                </select></td>
                <td><div class="task-cell">
                    <input type="checkbox" ${itemVS.completed ? 'checked' : ''} onchange="toggleMaint('${pathVS}', this.checked)">
                    <input type="date" class="${itemVS.completed ? '' : 'hidden-date'}" value="${itemVS.date || ''}" onchange="updateMaintDate('${pathVS}', this.value)">
                </div></td>
                <td><div class="task-cell">
                    <input type="checkbox" ${itemPF.completed ? 'checked' : ''} onchange="toggleMaint('${pathPF}', this.checked)">
                    <input type="date" class="${itemPF.completed ? '' : 'hidden-date'}" value="${itemPF.date || ''}" onchange="updateMaintDate('${pathPF}', this.value)">
                </div></td>
                <td><input type="text" class="note-input"
                    style="width: ${(noteContent.length + 10) * 8}px"
                    value="${noteContent.replace(/"/g, '&quot;')}"
                    placeholder="..."
                    oninput="this.style.width = ((this.value.length + 10) * 8) + 'px'"
                    onblur="updateOvenNote('${ovenName}', this.value)"></td>
            </tr>`;
        });

        let dPath6 = `dakuto.${viewYear}.06`; let item6 = safeGet(data, dPath6) || { completed: false, date: null };
        let dPath12 = `dakuto.${viewYear}.12`; let item12 = safeGet(data, dPath12) || { completed: false, date: null };
        const satDates = getTargetSaturdays(parseInt(viewYear), parseInt(viewMonth));
        const stats = calculateMaintenanceStats(data, viewYear, viewMonth);

        html += `<tr style="border-top: 2px solid #ccc; background:#f0f8ff;">
            <td colspan="2" style="font-weight:bold;">KH√ÅC</td>
            <td>
                <div style="font-weight:bold; margin-bottom:5px;">V·ªá sinh Dakuto (T6 & T12)</div>
                <div class="task-cell"><span>T6:</span><input type="checkbox" ${item6.completed?'checked':''} onchange="toggleMaint('${dPath6}', this.checked)"><input type="date" class="${item6.completed?'':'hidden-date'}" value="${item6.date||''}" onchange="updateMaintDate('${dPath6}', this.value)"></div>
                <div class="task-cell"><span>T12:</span><input type="checkbox" ${item12.completed?'checked':''} onchange="toggleMaint('${dPath12}', this.checked)"><input type="date" class="${item12.completed?'':'hidden-date'}" value="${item12.date||''}" onchange="updateMaintDate('${dPath12}', this.value)"></div>
            </td>
            <td style="background:#fff3cd; border: 1px solid #ffc107;">
                <div style="font-weight:bold; margin-bottom:5px; color: #856404;">L·ªäCH ƒêO BƒÇNG T·∫¢I</div>
                <div>Th·ª© 7 tu·∫ßn 1 & 3: <b style="color:var(--primary)">${satDates.length>0 ? satDates.join(', ') : 'Kh√¥ng c√≥'}</b></div>
            </td>
            <td style="background:#e9f7ef; border: 1px solid #28a745; color: #155724;">
                <div style="font-weight:bold;">TH·ªêNG K√ä HO√ÄN TH√ÄNH</div>
                <div>V·ªá sinh: <b>${stats.vesinhCompleted}/${stats.totalOvens}</b></div>
                <div>Profile: <b>${stats.profileCompleted}/${stats.totalOvens}</b></div>
            </td>
        </tr></tbody></table>`;
        container.innerHTML = html;

        document.querySelectorAll('.maintenance-table input[type="checkbox"]').forEach(cb => {
            if(cb.checked) {
                const di = cb.closest('.task-cell').querySelector('input[type="date"]');
                if(di) { di.classList.remove('hidden-date'); di.style.width='110px'; di.style.padding='3px'; di.style.border='1px solid #ddd'; }
            }
        });
    }

    async function changeOvenTemp(ovenName, newTemp) {
        ovenTemps[ovenName] = newTemp;
        await db.collection('maintenance').doc('schedules').update({ [`ovenTemps.${ovenName}`]: newTemp });
    }
    async function toggleMaint(path, isCompleted) {
        const updateData = {}; updateData[`${path}.completed`] = isCompleted;
        const checkbox = event.target;
        const dateInput = checkbox.closest('.task-cell').querySelector('input[type="date"]');
        if (isCompleted) {
            dateInput.classList.remove('hidden-date'); dateInput.style.width='110px'; dateInput.style.padding='3px'; dateInput.style.border='1px solid #ddd';
            if (!dateInput.value) { const today = new Date(); dateInput.value = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().slice(0, 10); }
            updateData[`${path}.date`] = dateInput.value;
        } else {
            dateInput.classList.add('hidden-date'); updateData[`${path}.date`] = null;
        }
        try { await db.collection('maintenance').doc('schedules').update(updateData); } catch (e) { await db.collection('maintenance').doc('schedules').set(updateData, { merge: true }); }
    }
    async function updateMaintDate(path, newDate) {
        try { await db.collection('maintenance').doc('schedules').update({ [`${path}.date`]: newDate }); } catch (e) { await db.collection('maintenance').doc('schedules').set({ [`${path}.date`]: newDate }, { merge: true }); }
    }
    async function updateOvenNote(ovenName, note) {
        const path = `ovens.${ovenName}.notes.${String(viewYear)}.${String(viewMonth).padStart(2,'0')}`;
        try { await db.collection('maintenance').doc('schedules').update({ [path]: note.trim() }); } catch (e) { await db.collection('maintenance').doc('schedules').set({ [path]: note.trim() }, { merge: true }); }
    }
    function hardResetMaintenance() {
        if(confirm("X√ìA TO√ÄN B·ªò d·ªØ li·ªáu b·∫£o tr√¨?")) db.collection('maintenance').doc('schedules').set({});
    }

    async function initializeFurnaces() {
        const snapshot = await db.collection(FURNACES_COLLECTION).get();
        currentFurnaceList = snapshot.docs.map(doc => doc.data().name).filter(name => name);
        updateDeleteFurnaceDropdown(currentFurnaceList);
    }
    async function addFurnaceToFirebase(name) {
        try { await db.collection(FURNACES_COLLECTION).add({ name: name }); return true; } catch(e){ return false; }
    }
    async function deleteFurnaceFromFirebase(name) {
         const snapshot = await db.collection(FURNACES_COLLECTION).where('name', '==', name).limit(1).get();
         if (!snapshot.empty) { await db.collection(FURNACES_COLLECTION).doc(snapshot.docs[0].id).delete(); return true; } return false;
    }
    function updateDeleteFurnaceDropdown(furnaces) {
        const select = document.getElementById('furnace-select-to-delete');
        select.innerHTML = '<option value="">-- Ch·ªçn L√≤ --</option>';
        furnaces.sort().forEach(f => select.innerHTML += `<option value="${f}">${f}</option>`);
    }
    function setupFurnaceListeners() {
        document.getElementById('add-furnace-btn').onclick = () => document.getElementById('add-furnace-dialog').style.display = 'block';
        document.getElementById('cancel-add-furnace-btn').onclick = () => document.getElementById('add-furnace-dialog').style.display = 'none';
        document.getElementById('save-new-furnace-btn').onclick = async () => {
            const name = document.getElementById('new-furnace-name').value.trim();
            if(name && await addFurnaceToFirebase(name)) {
                showToast("ƒê√£ th√™m l√≤ m·ªõi", "success"); currentFurnaceList.push(name); updateDeleteFurnaceDropdown(currentFurnaceList);
                document.getElementById('add-furnace-dialog').style.display = 'none';
            }
        };
        document.getElementById('delete-furnace-btn').onclick = () => document.getElementById('delete-furnace-dialog').style.display = 'block';
        document.getElementById('cancel-delete-btn').onclick = () => document.getElementById('delete-furnace-dialog').style.display = 'none';
        document.getElementById('confirm-delete-btn').onclick = async () => {
            const name = document.getElementById('furnace-select-to-delete').value;
            const pass = document.getElementById('delete-password-input').value;
            if(!name || !pass) return alert("Thi·∫øu th√¥ng tin");
            try {
                await auth.currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, pass));
                if(await deleteFurnaceFromFirebase(name)) {
                    showToast("X√≥a th√†nh c√¥ng!", "success"); currentFurnaceList = currentFurnaceList.filter(f => f!==name); updateDeleteFurnaceDropdown(currentFurnaceList);
                    document.getElementById('delete-furnace-dialog').style.display = 'none';
                }
            } catch(e) { showToast("M·∫≠t kh·∫©u sai!", "error"); }
        };
    }

    function readExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                resolve(XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" }));
            };
            reader.readAsArrayBuffer(file);
        });
    }

    async function handleFileSelection(event, type) {
        const files = Array.from(event.target.files);
        let allData = [];
        const label = document.getElementById(`fileList_${type}`);
        label.innerHTML = files.length ? files.map(f=>f.name).join(', ') : 'Ch∆∞a ch·ªçn file';
        label.style.color = files.length ? 'green' : 'red';
        if(type === 'IN') inputFiles = files; else outputFiles = files;
        try {
            const results = await Promise.all(files.map(readExcelFile));
            results.forEach(d => allData = allData.concat(d));
            if(type === 'IN') allInputData = allData; else allOutputData = allData;
            updatePersonSelectBox();
            showToast(`ƒê√£ t·∫£i xong ${files.length} file ${type}!`, "success");
        } catch(e) {
            document.getElementById('excelError').innerText = "L·ªói ƒë·ªçc file: " + e.message;
            showToast("L·ªói ƒë·ªçc file Excel!", "error");
        }
    }

    function updatePersonSelectBox() {
        const personSet = new Set();
        const colIndex = XLSX.utils.decode_col(document.getElementById('colPersonInput').value.trim().toUpperCase());
        const headerRows = parseInt(document.getElementById('headerRowInput').value) || 0;
        [allInputData, allOutputData].forEach(dataset => {
            dataset.forEach((row, idx) => { if(idx >= headerRows && row[colIndex]) personSet.add(String(row[colIndex]).trim()); });
        });
        const sel = document.getElementById('personSelect');
        const oldVal = sel.value;
        sel.innerHTML = '<option value="all">-- T·∫•t C·∫£ --</option>';
        Array.from(personSet).sort().forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
        if(personSet.has(oldVal)) sel.value = oldVal;
    }

    function showSection(sectionId) {
        document.getElementById('section-monthly').style.display = sectionId === 'monthly' ? 'block' : 'none';
        document.getElementById('section-daily').style.display = sectionId === 'daily' ? 'block' : 'none';
    }

    function calculatePanelsPerHour(personId, totalPanels) {
        const workingDays = parseFloat(document.getElementById(`days_${personId}`).value) || 0;
        const otHours = parseFloat(document.getElementById(`ot_${personId}`).value) || 0;
        const resultEl = document.getElementById(`pph_${personId}`);
        const totalHours = (workingDays * 8) + otHours;
        let pph = 0;
        if (totalHours > 0) pph = totalPanels / totalHours;
        resultEl.textContent = pph.toLocaleString('vi-VN', { maximumFractionDigits: 2 });
    }

    // --- MAIN LOGIC: B√ÅO C√ÅO TH√ÅNG ---
    function calculateProduction() {
        clearErrors();

        const getIndex = (id) => XLSX.utils.decode_col(document.getElementById(id).value.trim().toUpperCase());
        const colIndices = { prod: getIndex('colProdInput'), person: getIndex('colPersonInput'), process: getIndex('colProcessInput'), date: getIndex('colDateInput') };
        const headerRows = parseInt(document.getElementById('headerRowInput').value) || 0;
        const selPerson = document.getElementById('personSelect').value;
        const selMonth = document.getElementById('prodMonth').value;
        const selYear = document.getElementById('prodYear').value;

        processList = new Set();
        const resIn = allInputData.length ? processData(allInputData, colIndices, selPerson, selMonth, selYear, headerRows, 'IN') : {stats:{}, grandTotal:0};
        const resOut = allOutputData.length ? processData(allOutputData, colIndices, selPerson, selMonth, selYear, headerRows, 'OUT') : {stats:{}, grandTotal:0};
        const combined = combineStats(resIn.stats, resOut.stats);

        flushErrors();

        if(combined.grandTotal === 0) {
            if(detailedErrors.length > 0) {
                document.getElementById('excelError').innerText = "Kh√¥ng t√≠nh ƒë∆∞·ª£c do d·ªØ li·ªáu l·ªói (Xem chi ti·∫øt ·ªü tr√™n).";
            } else {
                document.getElementById('excelError').innerText = "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p (ki·ªÉm tra l·∫°i Th√°ng/NƒÉm).";
            }
            showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!", "error");
            document.getElementById('productionStatsContainer').innerHTML = '';
            return;
        }
        showToast("ƒê√£ t√≠nh to√°n xong!", "success");

        renderStatsTables({
            input: { title: 'ƒê·∫¶U V√ÄO', data: resIn.stats, total: resIn.grandTotal },
            output: { title: 'ƒê·∫¶U RA', data: resOut.stats, total: resOut.grandTotal },
            total: { title: `T·ªîNG H·ª¢P T${selMonth}/${selYear}`, data: combined.stats, total: combined.grandTotal }
        });
    }

    function processData(data, cols, person, month, year, headerRows, type) {
        let stats = {}, grandTotal = 0;
        data.forEach((row, idx) => {
            if(idx < headerRows) return;

            // --- VALIDATE NG√ÄY TH√ÅNG ---
            let d = row[cols.date];
            if (d && !(d instanceof Date)) {
                const str = String(d).trim();
                const parts = str.split('/');
                if (parts.length === 3) d = new Date(parts[2], parts[1]-1, parts[0]);
                else { const tempD = new Date(str); if (!isNaN(tempD.getTime())) d = tempD; }
            }
            if (!d || !(d instanceof Date) || isNaN(d.getTime())) {
                if(detailedErrors.length < 50) {
                    addError(`File ${type} - D√≤ng ${idx+1}: Ng√†y kh√¥ng h·ª£p l·ªá (Gi√° tr·ªã: "${row[cols.date] || 'r·ªóng'}")`);
                }
                return;
            }

            if(String(d.getMonth()+1).padStart(2,'0') !== month || String(d.getFullYear()) !== year) return;
            const pName = String(row[cols.person]||'').trim();
            if(person !== 'all' && pName !== person) return;
            const proc = String(row[cols.process]||'').trim();
            const val = parseFloat(String(row[cols.prod]||'0').replace(/,/g,'')) || 0;
            if(val > 0) {
                processList.add(proc);
                if(!stats[pName]) stats[pName] = { grandTotal: 0 };
                stats[pName][proc] = (stats[pName][proc] || 0) + val;
                stats[pName].grandTotal += val;
                grandTotal += val;
            }
        });
        return { stats, grandTotal };
    }

    function combineStats(s1, s2) {
        let res = {}, gt = 0;
        const names = new Set([...Object.keys(s1), ...Object.keys(s2)]);
        names.forEach(n => {
            res[n] = { grandTotal: 0 };
            processList.forEach(p => {
                const v = (s1[n]?.[p]||0) + (s2[n]?.[p]||0);
                if(v>0) { res[n][p] = v; res[n].grandTotal += v; }
            });
            gt += res[n].grandTotal;
        });
        return { stats: res, grandTotal: gt };
    }

    function renderStatsTables(dataMap) {
        const container = document.getElementById('productionStatsContainer');
        container.style.display = 'block'; container.innerHTML = '';
        const allProcs = Array.from(processList).sort();
        const peopleForInit = [];

        ['input', 'output', 'total'].forEach(key => {
            const item = dataMap[key];
            if(!item || item.total === 0) return;

            let html = `<div id="statsBox_${key}" style="margin-bottom: 20px;"><h3>${item.title}</h3><table class="stats-table" id="table_${key}">
                <thead><tr><th rowspan="2" class="person-col">Ng∆∞·ªùi</th><th colspan="${allProcs.length}">C√¥ng ƒêo·∫°n</th><th rowspan="2">T·ªïng</th>
                ${key === 'total' ? '<th style="background:#f0f8ff; color:#007bff">Ng√†y l√†m</th><th style="background:#f0f8ff; color:#007bff">Gi·ªù TC</th><th style="background:var(--success); color:white">T·∫§M/GI·ªú</th>' : ''}
                </tr><tr>${allProcs.map(p=>`<th>${p}</th>`).join('')}</tr></thead><tbody>`;

            const sortedPeople = Object.keys(item.data).map(name => ({
                name: name,
                stats: item.data[name]
            })).sort((a, b) => b.stats.grandTotal - a.stats.grandTotal);

            sortedPeople.forEach(personObj => {
                const name = personObj.name;
                const stats = personObj.stats;
                const pid = name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                const total = stats.grandTotal;

                if(key==='total') peopleForInit.push({id:pid, total:total});

                html += `<tr id="person_${pid}"><td class="person-col">${name}</td>`;
                allProcs.forEach(p => {
                    const v = stats[p] || 0;
                    html += `<td class="${getColorClass(p)}">${v > 0 ? v.toLocaleString() : '-'}</td>`;
                });
                html += `<td class="total-col">${total.toLocaleString()}</td>`;
                if(key==='total') {
                    html += `<td><input type="number" id="days_${pid}" value="20" style="width:50px" oninput="calculatePanelsPerHour('${pid}', ${total})"></td>
                             <td><input type="number" id="ot_${pid}" value="0" style="width:50px" oninput="calculatePanelsPerHour('${pid}', ${total})"></td>
                             <td id="pph_${pid}" class="total-col" style="background:#e9f7ef; color:#155724">0.00</td>`;
                }
                html += `</tr>`;
            });

            const cs = key === 'total' ? allProcs.length + 1 : allProcs.length;
            html += `<tr class="grand-total-row"><th>T·ªîNG C·ªòNG</th>${allProcs.map(()=>'<td></td>').join('')}<td class="total-col">${item.total.toLocaleString()}</td>${key==='total'?'<td colspan="3"></td>':''}</tr>`;
            html += `</tbody></table></div>`;
            container.insertAdjacentHTML('beforeend', html);
        });

        if(peopleForInit.length > 0) {
            setTimeout(() => { peopleForInit.forEach(p => { if(document.getElementById(`days_${p.id}`)) calculatePanelsPerHour(p.id, p.total); }); }, 100);
        }
        document.getElementById('exportBtn').style.display = 'inline-block';
        document.getElementById('captureBtn').style.display = 'inline-block';
    }

    function updateShiftTimeInputs() {
        const val = document.getElementById('shiftSelect').value;
        if(val === 'DAY') {
            document.getElementById('customStartTime').value = "07:00";
            document.getElementById('customEndTime').value = "19:00";
        } else {
            document.getElementById('customStartTime').value = "19:00";
            document.getElementById('customEndTime').value = "07:00";
        }
    }

    // --- C·∫¨P NH·∫¨T: T√çNH HI·ªÜU SU·∫§T (NG∆Ø·ªúI L√ÄM R√ï LOT/DAMI) ---
    function calculateFurnaceEfficiency() {
        clearErrors();

        const container = document.getElementById('dailyFurnaceContainer');
        container.innerHTML = '';
        document.getElementById('excelError').innerText = '';

        if (allInputData.length === 0 && allOutputData.length === 0) {
            showToast("Ch∆∞a t·∫£i file d·ªØ li·ªáu n√†o (IN ho·∫∑c OUT)!", "error");
            return;
        }

        const selDateVal = document.getElementById('dailyDate').value;
        const startTimeInput = document.getElementById('customStartTime').value;
        const endTimeInput = document.getElementById('customEndTime').value;

        if (!selDateVal) { showToast("Vui l√≤ng ch·ªçn ng√†y!", "error"); return; }
        if (!startTimeInput || !endTimeInput) { showToast("Vui l√≤ng nh·∫≠p gi·ªù!", "error"); return; }

        let startDateTime = new Date(`${selDateVal}T${startTimeInput}`);
        let endDateTime = new Date(`${selDateVal}T${endTimeInput}`);

        // X·ª≠ l√Ω qua ƒë√™m
        if (endTimeInput <= startTimeInput) {
            endDateTime.setDate(endDateTime.getDate() + 1);
        }

        const diffMs = endDateTime - startDateTime;
        const totalMinutes = Math.floor(diffMs / 60000);

        showToast(`ƒêang t√≠nh to√°n (${totalMinutes} ph√∫t)...`, "info");

        // --- L·∫§Y INDEX C√ÅC C·ªòT ---
        const getIndex = (id) => XLSX.utils.decode_col(document.getElementById(id).value.trim().toUpperCase());
        const idxDate = getIndex('colDateInput');
        const idxType = getIndex('colTypeInput');
        const idxFurnace = getIndex('colFurnaceInput');
        const idxScrap = getIndex('colScrapInput');
        const idxPerson = getIndex('colPersonInput');
        const idxProcess = getIndex('colProcessInput');

        // [NEW] L·∫•y index c·ªôt Keijo
        const idxKeijo = getIndex('colKeijoInput');

        let furnaceStats = {};
        let grandTotalLots = 0;
        let grandTotalDummies = 0;
        let grandTotalScrap = 0;

        const combinedData = [...allInputData, ...allOutputData];

        combinedData.forEach((row, i) => {
            if (!row || row.length === 0) return;

            let d = row[idxDate];
            if (d && !(d instanceof Date)) {
                const str = String(d).trim();
                const parts = str.split('/');
                if (parts.length === 3) d = new Date(parts[2], parts[1]-1, parts[0]);
                else { const tempD = new Date(str); if (!isNaN(tempD.getTime())) d = tempD; }
            }

            if (!d || !(d instanceof Date) || isNaN(d.getTime())) return;
            if (d < startDateTime || d > endDateTime) return;

            const typeCode = String(row[idxType] || '').trim().toUpperCase();
            const furnaceName = String(row[idxFurnace] || 'Unknown').trim();
            const scrapVal = parseFloat(row[idxScrap]) || 0;
            const personName = String(row[idxPerson] || 'Unknown').trim();
            const procName = String(row[idxProcess] || 'Kh√¥ng x√°c ƒë·ªãnh').trim();
            const keijoVal = String(row[idxKeijo] || '').trim();

            if (!furnaceStats[furnaceName]) {
                furnaceStats[furnaceName] = {
                    items: {},
                    totalLots: 0,
                    totalDummies: 0,
                    totalScrap: 0,
                    operators: {}
                };
            }

            // Group by Process + Keijo
            const uniqueKey = procName + '|||' + keijoVal;

            if (!furnaceStats[furnaceName].items[uniqueKey]) {
                furnaceStats[furnaceName].items[uniqueKey] = {
                    procName: procName,
                    keijo: keijoVal,
                    lots: 0,
                    dummies: 0
                };
            }
            if (!furnaceStats[furnaceName].operators[personName]) {
                furnaceStats[furnaceName].operators[personName] = { lots: 0, dummies: 0 };
            }

            if (typeCode.startsWith('C')) {
                furnaceStats[furnaceName].items[uniqueKey].lots += 1;
                furnaceStats[furnaceName].totalLots += 1;
                furnaceStats[furnaceName].operators[personName].lots += 1;
                grandTotalLots += 1;
            } else if (typeCode.startsWith('D')) {
                furnaceStats[furnaceName].items[uniqueKey].dummies += 1;
                furnaceStats[furnaceName].totalDummies += 1;
                furnaceStats[furnaceName].operators[personName].dummies += 1;
                grandTotalDummies += 1;
            }
            furnaceStats[furnaceName].totalScrap += scrapVal;
            grandTotalScrap += scrapVal;
        });

        flushErrors();

        if (Object.keys(furnaceStats).length === 0) {
            container.innerHTML = '<p style="color:red; font-weight:bold; text-align:center;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</p>';
            return;
        }

        // --- V·∫º B·∫¢NG M·ªöI ---
        let html = `<table class="stats-table">
            <thead>
                <tr style="background-color: #007bff; color: white;">
                    <th>T√™n L√≤</th>
                    <th>C√¥ng ƒêo·∫°n</th>
                    <th>Keijo</th>
                    <th>Lot (C)</th>
                    <th>Dami (D)</th>
                    <th>Ph·∫ø Ph·∫©m</th>
                    <th style="background-color: #0056b3;">Ph√∫t/Lot</th>
                    <th>Ng∆∞·ªùi Thao T√°c</th>
                </tr>
            </thead>
            <tbody>`;

        Object.keys(furnaceStats).sort().forEach(fName => {
            const item = furnaceStats[fName];
            const itemKeys = Object.keys(item.items).sort();
            const rowSpan = itemKeys.length;

            let minPerLotStr = "-";
            if (item.totalLots > 0) {
                const val = totalMinutes / item.totalLots;
                minPerLotStr = val.toLocaleString('vi-VN', { maximumFractionDigits: 1 });
            }

            // --- FORMAT HI·ªÇN TH·ªä NG∆Ø·ªúI THAO T√ÅC R√ï R√ÄNG ---
            const operatorStr = Object.entries(item.operators)
                .map(([pName, pStats]) => `
                    <div style="border-bottom: 1px dashed #ccc; padding: 2px 0;">
                        <strong>${pName}</strong>:
                        <span style="color:green">Lot ${pStats.lots}</span> |
                        <span style="color:#666">Dami ${pStats.dummies}</span>
                    </div>`)
                .join('');

            itemKeys.forEach((key, index) => {
                const pStats = item.items[key];
                html += `<tr>`;

                if (index === 0) {
                    html += `<td rowspan="${rowSpan}" class="furnace-row-header" style="vertical-align: top; color:#007bff; font-size:16px;">${fName}</td>`;
                }

                html += `<td style="font-weight:bold;">${pStats.procName}</td>
                         <td style="color: #333;">${pStats.keijo}</td>
                         <td style="color: green; font-weight:bold;">${pStats.lots}</td>
                         <td style="color: #666;">${pStats.dummies}</td>`;

                if (index === 0) {
                    html += `<td rowspan="${rowSpan}" style="color: red; font-weight:bold; vertical-align: top;">${item.totalScrap}</td>
                             <td rowspan="${rowSpan}" style="vertical-align: top; font-weight:bold; color:#d63384; font-size:15px; background-color:#fff0f6;">${minPerLotStr}</td>
                             <td rowspan="${rowSpan}" style="text-align:left; vertical-align: top; font-size:13px;">${operatorStr}</td>`;
                }
                html += `</tr>`;
            });
        });

        html += `<tr class="grand-total-footer">
            <td colspan="3" style="text-align: right;">T·ªîNG C·ªòNG:</td>
            <td style="color: green; font-size: 16px;">${grandTotalLots}</td>
            <td style="font-size: 16px;">${grandTotalDummies}</td>
            <td style="color: red; font-size: 16px;">${grandTotalScrap}</td>
            <td colspan="2"></td>
        </tr>`;

        html += `</tbody></table>`;
        container.innerHTML = html;
        showToast("Ph√¢n t√≠ch ho√†n t·∫•t!", "success");
    }

    function exportToExcel() {
        const month = document.getElementById('prodMonth').value;
        const year = document.getElementById('prodYear').value;
        const wb = XLSX.utils.book_new();

        const getTableData = (tableId) => {
             const tbl = document.getElementById(tableId);
             if(!tbl) return null;
             const clone = tbl.cloneNode(true);
             const inputs = tbl.querySelectorAll('input');
             const cloneInputs = clone.querySelectorAll('input');
             inputs.forEach((inp, i) => {
                 if(cloneInputs[i]) cloneInputs[i].parentElement.innerHTML = inp.value;
             });
             return XLSX.utils.table_to_sheet(clone);
        };

        ['table_input', 'table_output', 'table_total'].forEach((tid, idx) => {
             const ws = getTableData(tid);
             if(ws) XLSX.utils.book_append_sheet(wb, ws, `Sheet_${idx+1}`);
        });
        XLSX.writeFile(wb, `BaoCao_T${month}_${year}.xlsx`);
    }

    function captureAndDownloadStats() {
        const container = document.getElementById('productionStatsContainer');
        if (!container || container.style.display === 'none') return;
        const inputs = container.querySelectorAll('input');
        inputs.forEach(inp => { inp.style.display = 'none'; inp.parentElement.insertAdjacentHTML('beforeend', `<span class="temp-val">${inp.value}</span>`); });

        html2canvas(container).then(canvas => {
            const link = document.createElement('a');
            link.download = `BaoCao.png`;
            link.href = canvas.toDataURL();
            link.click();
            inputs.forEach(inp => { inp.style.display = 'inline-block'; });
            container.querySelectorAll('.temp-val').forEach(e => e.remove());
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        initializeFurnaces();
        setupFurnaceListeners();
    });

</script>
</body>
</html>