<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Lot & B·∫£o Tr√¨ - Final Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- GIAO DI·ªÜN C∆† B·∫¢N --- */
        :root {
            --primary: #007bff; --success: #28a745; --danger: #dc3545;
            --text: #333; --bg: #f4f6f9; --border: #dee2e6;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }

        /* --- KHUNG ƒêƒÇNG NH·∫¨P --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 8px; width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }

        /* --- GIAO DI·ªÜN CH√çNH --- */
        #main-app { display: none; width: 100%; max-width: 1380px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; }

        /* --- N√öT B·∫§M & INPUT --- */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .search-box { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 300px; }

        /* --- B·∫¢NG D·ªÆ LI·ªÜU --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        th { background: var(--primary); color: white; text-transform: uppercase; font-size: 13px; }
        td input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        /* --- TR·∫†NG TH√ÅI --- */
        .status-select { padding: 5px; border-radius: 4px; font-weight: bold; border: 1px solid #ccc; }
        .st-pending { color: orange; border-color: orange; }
        .st-running { color: var(--primary); border-color: var(--primary); }
        .st-done { color: var(--success); border-color: var(--success); }

        /* --- FORM TH√äM LOT --- */
        #add-lot-form { display: none; background: var(--bg); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); }
        #add-lot-form textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 8px; }

        /* --- PH·∫¶N B·∫¢O TR√å (C·∫¢I TI·∫æN) --- */
        .maintenance-section { margin-top: 40px; border-top: 2px dashed var(--border); padding-top: 20px; }
        .maintenance-controls { display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .maintenance-controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; font-weight: bold; }

        /* Style cho √¥ b·∫£o tr√¨ thu g·ªçn */
        .task-cell { display: flex; align-items: center; gap: 8px; }
        .task-cell input[type="date"] {
            border: 1px solid #ddd; padding: 3px; border-radius: 4px; font-size: 12px;
            width: 110px; transition: 0.2s;
        }
        .hidden-date { opacity: 0; pointer-events: none; width: 0 !important; padding: 0 !important; border: none !important; }

        /* Style cho √¥ ghi ch√∫ */
        .note-input { width: 100%; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .note-input:focus { border-color: var(--primary); outline: none; }

        /* --- TI·ªÜN √çCH --- */
        .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }
        .error-display { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>ƒêƒÉng Nh·∫≠p</h2>
            <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
            <button onclick="handleLogin()">V√ÄO H·ªÜ TH·ªêNG</button>
            <p id="login-msg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="main-app">
        <header>
            <h1>QU·∫¢N L√ù LOT ∆ØU TI√äN</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <input type="text" class="search-box" id="searchInput" placeholder="T√¨m s·ªë Lot ho·∫∑c Keijo..." onkeyup="renderLotsTable()">
            <div>
                <button class="btn btn-danger" id="btnDeleteMulti" onclick="deleteSelected()" style="display:none; margin-right: 10px;">X√≥a ƒë√£ ch·ªçn</button>
                <button class="btn btn-success" onclick="toggleAddForm()">+ Th√™m Lot M·ªõi</button>
            </div>
        </div>

        <div id="add-lot-form">
            <h3>Th√™m nhanh (Copy t·ª´ Excel)</h3>
            <textarea id="inputLotData" placeholder="D√°n d·ªØ li·ªáu: Lot  Keijo  ƒêi·ªánTr·ªü (M·ªói d√≤ng 1 lot) VD: CKP6A0000 Z18 332"></textarea>
            <select id="inputProcess" style="padding: 8px; width: 200px; margin-bottom: 10px;">
                <option value="">-- Ch·ªçn C√¥ng ƒêo·∫°n --</option>
                <option value="UC">UC</option><option value="C">C</option><option value="R">R</option>
                <option value="T1">T1</option><option value="CLF">CLF</option><option value="T2">T2</option>
                <option value="T3">T3</option><option value="G1">G1</option><option value="GH">GH</option>
            </select>
            <br>
            <button class="btn btn-primary" onclick="submitNewLots()">L∆∞u D·ªØ Li·ªáu</button>
            <button class="btn btn-danger" onclick="toggleAddForm()">H·ªßy</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="checkAll" onchange="toggleSelectAll()"></th>
                    <th>STT</th>
                    <th>Lot</th>
                    <th>Keijo</th>
                    <th>ƒêi·ªán tr·ªü</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Gi·ªù ra l√≤</th>
                    <th>C√¥ng ƒëo·∫°n</th>
                    <th>Ghi ch√∫</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="lotTableBody"></tbody>
        </table>

        <div style="margin-top: 15px; text-align: right;">
            <span id="pagingInfo"></span>
            <button class="btn btn-primary" onclick="prevPage()"> < </button>
            <button class="btn btn-primary" onclick="nextPage()"> > </button>
        </div>

        <div class="maintenance-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üõ† L·ªäCH S·ª¨ B·∫¢O TR√å</h2>

                <div class="maintenance-controls">
                    <span>Xem d·ªØ li·ªáu:</span>
                    <select id="viewMonth" onchange="changeViewDate()"></select>
                    <select id="viewYear" onchange="changeViewDate()"></select>
                    <button class="btn btn-outline" onclick="jumpToNow()">V·ªÅ hi·ªán t·∫°i</button>
                </div>
            </div>

            <div id="maintenanceError" class="error-display">
                C√≥ l·ªói t·∫£i d·ªØ li·ªáu. <button class="btn btn-danger" onclick="hardResetMaintenance()">Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</button>
            </div>

            <div id="maintenanceLoading" class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu b·∫£o tr√¨...</div>
            <div id="maintenanceContent" style="display: none;">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // 1. C·∫§U H√åNH FIREBASE & DISCORD
        const firebaseConfig = {
            apiKey: "AIzaSyCn866gY_3OiB_VL0fUDMe3ZCdhYDRbIJ8",
            authDomain: "lot-priority-app-shared.firebaseapp.com",
            projectId: "lot-priority-app-shared",
            storageBucket: "lot-priority-app-shared.firebasestorage.app",
            messagingSenderId: "12749059268",
            appId: "1:12749059268:web:e1aa877135d8741461c591",
            measurementId: "G-DPNT9PZ61Y"
        };

        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1377130413708808272/BH7cEuL4lWI6C-FfhNGnl84kgZ_LnqWn8TVIY8uuesT69PzrXuxZ60Uv4Tm1TFMW9BdC";

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. BI·∫æN TO√ÄN C·ª§C
        let rawLots = [];
        let selectedIds = [];
        let curPage = 1;
        const pageSize = 10;

        let viewYear = new Date().getFullYear();
        let viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
        let maintenanceDataCache = {};

        const OVEN_LIST = [1,2,3,4,5,6,7];

        // --- C·∫¨P NH·∫¨T: Kh·ªüi t·∫°o m·∫∑c ƒë·ªãnh, s·∫Ω ƒë∆∞·ª£c ghi ƒë√® t·ª´ Firebase ---
        let ovenTemps = { 'L√≤ 1': '850', 'L√≤ 2': '850', 'L√≤ 3': '850', 'L√≤ 4': '850', 'L√≤ 5': '850', 'L√≤ 6': '850', 'L√≤ 7': '850' };

        // --- H√ÄM G·ª¨I DISCORD ---
        function sendDiscordNotification(message) {
            if(!DISCORD_WEBHOOK_URL) {
                console.warn("Ch∆∞a c·∫•u h√¨nh URL Discord");
                return;
            }

            console.log("ƒêang g·ª≠i Discord:", message);

            fetch(DISCORD_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: message })
            })
            .then(response => {
                if(response.ok) console.log("G·ª≠i Discord th√†nh c√¥ng");
                else console.error("L·ªói g·ª≠i Discord:", response.status);
            })
            .catch(err => {
                console.error("L·ªói m·∫°ng g·ª≠i Discord:", err);
            });
        }

        // --- H√ÄM T√çNH TO√ÅN NG√ÄY TH·ª® 7 TU·∫¶N 1 & 3 ---
        function getTargetSaturdays(year, month) {
            const dates = [];
            const date = new Date(year, month - 1, 1);
            let saturdayCount = 0;

            while (date.getMonth() === (month - 1)) {
                if (date.getDay() === 6) { // Th·ª© 7 (Saturday)
                    saturdayCount++;
                    if (saturdayCount === 1 || saturdayCount === 3) {
                        dates.push(new Date(date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                    }
                }
                date.setDate(date.getDate() + 1);
            }
            return dates;
        }

        // --- H√ÄM T√çNH TO√ÅN TH·ªêNG K√ä HO√ÄN TH√ÄNH ---
        function calculateMaintenanceStats(data, year, month) {
            let stats = {
                vesinhCompleted: 0,
                profileCompleted: 0,
                totalOvens: OVEN_LIST.length
            };

            OVEN_LIST.forEach(id => {
                const ovenName = `L√≤ ${id}`;
                // S·ª≠ d·ª•ng nhi·ªát ƒë·ªô ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Firebase
                const curTemp = ovenTemps[ovenName] || '850';

                // Check V·ªá sinh
                let pathVS = `ovens.${ovenName}.${curTemp}.V·ªá sinh.${year}.${month}.completed`;
                if (safeGet(data, pathVS) === true) {
                    stats.vesinhCompleted++;
                }

                // Check ƒêo Profile
                let pathPF = `ovens.${ovenName}.${curTemp}.ƒêo Profile.${year}.${month}.completed`;
                if (safeGet(data, pathPF) === true) {
                    stats.profileCompleted++;
                }
            });

            return stats;
        }

        // 3. KH·ªûI T·∫†O MENU TH·ªúI GIAN
        function initDateControls() {
            const selM = document.getElementById('viewMonth');
            const selY = document.getElementById('viewYear');
            selM.innerHTML = '';
            for(let i=1; i<=12; i++) selM.innerHTML += `<option value="${String(i).padStart(2, '0')}">Th√°ng ${i}</option>`;
            selY.innerHTML = '';
            const currentY = new Date().getFullYear();
            for(let i = currentY - 1; i <= currentY + 5; i++) selY.innerHTML += `<option value="${i}">NƒÉm ${i}</option>`;
            selM.value = viewMonth;
            selY.value = viewYear;
        }

        // --- S·ª¨A L·ªñI: C·∫ßn g·ªçi renderMaintenanceUI ƒë·ªÉ √°p d·ª•ng th√°ng/nƒÉm m·ªõi ---
        function jumpToNow() {
            viewYear = new Date().getFullYear();
            viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
            document.getElementById('viewMonth').value = viewMonth;
            document.getElementById('viewYear').value = viewYear;
            if (Object.keys(maintenanceDataCache).length > 0) {
                renderMaintenanceUI(maintenanceDataCache);
            }
            // loadMaintenanceData() kh√¥ng c·∫ßn thi·∫øt v√¨ onSnapshot ƒë√£ c√≥ s·∫µn data
        }

        // --- S·ª¨A L·ªñI: C·∫ßn g·ªçi renderMaintenanceUI ƒë·ªÉ √°p d·ª•ng th√°ng/nƒÉm m·ªõi ---
        function changeViewDate() {
            viewMonth = document.getElementById('viewMonth').value;
            viewYear = document.getElementById('viewYear').value;
            // G·ªçi render l·∫°i UI v·ªõi d·ªØ li·ªáu ƒë√£ cache nh∆∞ng d√πng viewYear/viewMonth m·ªõi
            if (Object.keys(maintenanceDataCache).length > 0) {
                renderMaintenanceUI(maintenanceDataCache);
            }
        }

        // 4. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initDateControls();
                initApp();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            try { await auth.signInWithEmailAndPassword(`${u}@lot-priority-app-shared.com`, p); }
            catch (e) { document.getElementById('login-msg').innerText = "Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!"; }
        }
        function handleLogout() { auth.signOut(); }

        // 5. LOGIC H·ªÜ TH·ªêNG CHUNG
        function initApp() {
            db.collection('lots').onSnapshot(snap => {
                rawLots = [];
                snap.forEach(doc => rawLots.push({id: doc.id, ...doc.data()}));
                rawLots.sort((a, b) => {
                    const score = s => s === 'ƒêang nung' ? 0 : (s === 'Ch·ªù x·ª≠ l√Ω' ? 1 : 2);
                    return score(a.status) - score(b.status) || (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                });
                renderLotsTable();
            });

            // Theo d√µi thay ƒë·ªïi c·ªßa document b·∫£o tr√¨ ƒë·ªÉ c·∫≠p nh·∫≠t real-time
            db.collection('maintenance').doc('schedules').onSnapshot(doc => {
                const docData = doc.exists ? doc.data() : {};
                maintenanceDataCache = docData;

                // --- ƒê·ªìng b·ªô ovenTemps t·ª´ Firebase khi c√≥ thay ƒë·ªïi ---
                const defaultTemps = { 'L√≤ 1': '850', 'L√≤ 2': '850', 'L√≤ 3': '850', 'L√≤ 4': '850', 'L√≤ 5': '850', 'L√≤ 6': '850', 'L√≤ 7': '850' };
                ovenTemps = docData.ovenTemps ? { ...defaultTemps, ...docData.ovenTemps } : defaultTemps;

                if (!maintenanceDataCache.ovens) maintenanceDataCache.ovens = {};
                if (!maintenanceDataCache.dakuto) maintenanceDataCache.dakuto = {};

                renderMaintenanceUI(maintenanceDataCache);
            }, (error) => {
                console.error("L·ªói l·∫Øng nghe Firebase:", error);
                document.getElementById('maintenanceError').style.display = 'block';
                document.getElementById('maintenanceLoading').style.display = 'none';
            });

            checkConveyorReminder();
        }

        // --- H√†m t·∫£i d·ªØ li·ªáu b·∫£o tr√¨ th·ªß c√¥ng (ch·ªâ d√πng ƒë·ªÉ set default n·∫øu ch∆∞a c√≥) ---
        async function loadMaintenanceData() {
            const docRef = db.collection('maintenance').doc('schedules');
            const doc = await docRef.get();

            if (!doc.exists || !doc.data().ovenTemps) {
                // N·∫øu ch∆∞a c√≥ tr√™n DB, d√πng m·∫∑c ƒë·ªãnh v√† l∆∞u l√™n DB l·∫ßn ƒë·∫ßu
                await docRef.set({ ovenTemps: ovenTemps }, { merge: true });
            }
        }


        // --- KI·ªÇM TRA NH·∫ÆC NH·ªû BƒÇNG T·∫¢I (Th·ª© 6 b√°o tr∆∞·ªõc 1 ng√†y) ---
        function checkConveyorReminder() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 5=Fri
            if (dayOfWeek !== 5) return;

            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const weekOfMonth = Math.ceil(tomorrow.getDate() / 7);

            if (weekOfMonth === 1 || weekOfMonth === 3) {
                const todayStr = today.toISOString().split('T')[0];
                const lastSent = localStorage.getItem('discord_conveyor_sent');

                if (lastSent !== todayStr) {
                    sendDiscordNotification(`‚ö†Ô∏è **NH·∫ÆC NH·ªû B·∫¢O TR√å:**\nNg√†y mai (Th·ª© 7 - Tu·∫ßn ${weekOfMonth}) l√† l·ªãch **ƒêo t·ªëc ƒë·ªô bƒÉng t·∫£i**. Vui l√≤ng chu·∫©n b·ªã!`);
                    localStorage.setItem('discord_conveyor_sent', todayStr);
                }
            }
        }

        function renderLotsTable() {
            const tbody = document.getElementById('lotTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));

            const total = filtered.length;
            const pages = Math.ceil(total / pageSize) || 1;
            if (curPage > pages) curPage = pages;
            const start = (curPage - 1) * pageSize;
            const displayLots = filtered.slice(start, start + pageSize);

            tbody.innerHTML = '';
            displayLots.forEach((item, idx) => {
                const stClass = item.status === 'ƒêang nung' ? 'st-running' : (item.status === 'Ho√†n th√†nh' ? 'st-done' : 'st-pending');
                const isChecked = selectedIds.includes(item.id) ? 'checked' : '';

                const row = `<tr>
                    <td><input type="checkbox" ${isChecked} onchange="toggleOne('${item.id}')"></td>
                    <td>${start + idx + 1}</td>
                    <td contenteditable="true" onblur="updateCell('${item.id}', 'lot', this)">${item.lot}</td>
                    <td contenteditable="true" onblur="updateCell('${item.id}', 'keijo', this)">${item.keijo}</td>
                    <td contenteditable="true" onblur="updateCell('${item.id}', 'resistance', this)">${item.resistance}</td>
                    <td>
                        <select class="status-select ${stClass}" onchange="changeStatus('${item.id}', this)">
                            <option value="Ch·ªù x·ª≠ l√Ω" ${item.status==='Ch·ªù x·ª≠ l√Ω'?'selected':''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="ƒêang nung" ${item.status==='ƒêang nung'?'selected':''}>ƒêang nung</option>
                            <option value="Ho√†n th√†nh" ${item.status==='Ho√†n th√†nh'?'selected':''}>Ho√†n th√†nh</option>
                        </select>
                    </td>
                    <td><input type="datetime-local" value="${item.time || ''}" onchange="updateCell('${item.id}', 'time', this)"></td>
                    <td contenteditable="true" onblur="updateCell('${item.id}', 'process', this)">${item.process}</td>
                    <td contenteditable="true" onblur="updateCell('${item.id}', 'note', this)">${item.note || ''}</td>
                    <td><button class="btn btn-danger" style="padding: 4px 8px;" onclick="deleteLot('${item.id}')">X√≥a</button></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            document.getElementById('pagingInfo').innerText = `Trang ${curPage}/${pages}`;
            document.getElementById('btnDeleteMulti').style.display = selectedIds.length > 0 ? 'inline-block' : 'none';
            document.getElementById('btnDeleteMulti').innerText = `X√≥a (${selectedIds.length})`;
        }

        // 6. C√ÅC H√ÄM THAO T√ÅC LOT
        function updateCell(id, field, el) {
            let val = el.value !== undefined ? el.value : el.innerText;
            if(field === 'lot') val = val.toUpperCase();
            db.collection('lots').doc(id).update({ [field]: val });
        }
        function changeStatus(id, el) {
            const st = el.value;
            let updateData = { status: st };
            if(st === 'ƒêang nung') {
                const d = new Date(); d.setMinutes(d.getMinutes() + 105);
                const iso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                updateData.time = iso;
            }
            db.collection('lots').doc(id).update(updateData);
        }
        function toggleAddForm() { const f = document.getElementById('add-lot-form'); f.style.display = f.style.display === 'block' ? 'none' : 'block'; }

        async function submitNewLots() {
            const raw = document.getElementById('inputLotData').value;
            const proc = document.getElementById('inputProcess').value;
            if(!raw || !proc) return alert("Thi·∫øu d·ªØ li·ªáu!");
            const batch = db.batch();
            const lines = raw.split('\n');
            let count = 0;
            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                if(parts.length >= 3) {
                    const ref = db.collection('lots').doc();
                    batch.set(ref, { lot: parts[0].toUpperCase(), keijo: parts[1], resistance: parts[2], process: proc, status: 'Ch·ªù x·ª≠ l√Ω', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    count++;
                }
            });
            if(count > 0) {
                await batch.commit();

                // --- G·ª¨I DISCORD KHI C√ì LOT M·ªöI ---
                sendDiscordNotification(`üÜï **ƒê√£ th√™m ${count} Lot m·ªõi!**\nC√¥ng ƒëo·∫°n: **${proc}**`);

                alert(`ƒê√£ th√™m ${count} lot.`);
                document.getElementById('inputLotData').value = '';
                toggleAddForm();
            } else { alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d√≤ng n√†o h·ª£p l·ªá!"); }
        }

        async function deleteLot(id) { if(await confirmPass()) db.collection('lots').doc(id).delete(); }
        async function deleteSelected() {
            if(selectedIds.length === 0) return;
            if(await confirmPass()) {
                const batch = db.batch();
                selectedIds.forEach(id => batch.delete(db.collection('lots').doc(id)));
                await batch.commit();
                selectedIds = [];
                renderLotsTable();
            }
        }
        async function confirmPass() {
            if(!auth.currentUser) return false;
            const p = prompt("Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ x√°c nh·∫≠n x√≥a:");
            if(!p) return false;
            try { const cred = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, p); await auth.currentUser.reauthenticateWithCredential(cred); return true; } catch { alert("Sai m·∫≠t kh·∫©u!"); return false; }
        }
        function toggleOne(id) { if(selectedIds.includes(id)) selectedIds = selectedIds.filter(x => x !== id); else selectedIds.push(id); renderLotsTable(); }
        function toggleSelectAll() {
            const chk = document.getElementById('checkAll').checked;
            if(chk) {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search));
                const start = (curPage - 1) * pageSize;
                const pageIds = filtered.slice(start, start + pageSize).map(l => l.id);
                selectedIds = [...new Set([...selectedIds, ...pageIds])];
            } else { selectedIds = []; }
            renderLotsTable();
        }
        function prevPage() { if(curPage > 1) { curPage--; renderLotsTable(); } }
        function nextPage() { curPage++; renderLotsTable(); }

        // 7. H·ªÜ TH·ªêNG B·∫¢O TR√å (THU G·ªåN + GHI CH√ö)
        function safeGet(obj, path) {
            return path.split('.').reduce((acc, part) => acc && acc[part], obj);
        }

        // --- C·∫¨P NH·∫¨T: Thay th·∫ø localStorage b·∫±ng Firebase ---
        async function changeOvenTemp(ovenName, newTemp) {
            ovenTemps[ovenName] = newTemp;

            // C·∫≠p nh·∫≠t l√™n Firebase
            await db.collection('maintenance').doc('schedules').update({
                [`ovenTemps.${ovenName}`]: newTemp
            });
            // onSnapshot trong initApp s·∫Ω t·ª± ƒë·ªông render l·∫°i UI cho t·∫•t c·∫£ m√°y
        }

        function renderMaintenanceUI(data) {
            const container = document.getElementById('maintenanceContent');
            const uiLoading = document.getElementById('maintenanceLoading');
            const uiContent = document.getElementById('maintenanceContent');

            uiLoading.style.display = 'none';
            uiContent.style.display = 'block';

            let html = `<p style="font-style:italic; color:#666; margin-bottom:10px;">ƒêang xem d·ªØ li·ªáu: <b>Th√°ng ${viewMonth} / NƒÉm ${viewYear}</b></p>`;

            html += `<table class="maintenance-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Thi·∫øt b·ªã</th>
                        <th style="width: 100px;">Nhi·ªát ƒë·ªô</th>
                        <th>V·ªá sinh (850 1T/L·∫¶N)</th>
                        <th>ƒêo Profile (3T/L·∫¶N)</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>`;

            // 1. RENDER L√í - LOGIC THU G·ªåN
            OVEN_LIST.forEach(id => {
                const ovenName = `L√≤ ${id}`;
                // L·∫•y nhi·ªát ƒë·ªô ƒë√£ ƒë·ªìng b·ªô
                const curTemp = ovenTemps[ovenName] || '850';

                // L·∫•y d·ªØ li·ªáu
                let pathVS = `ovens.${ovenName}.${curTemp}.V·ªá sinh.${viewYear}.${viewMonth}`;
                let itemVS = safeGet(data, pathVS) || { completed: false, date: null };

                let pathPF = `ovens.${ovenName}.${curTemp}.ƒêo Profile.${viewYear}.${viewMonth}`;
                let itemPF = safeGet(data, pathPF) || { completed: false, date: null };

                // L·∫•y ghi ch√∫
                let pathNote = `ovens.${ovenName}.notes.${viewYear}.${viewMonth}`;
                let noteContent = safeGet(data, pathNote) || "";

                html += `<tr>
                    <td style="font-weight:bold; background:#f9f9f9;">${ovenName}</td>
                    <td>
                        <select onchange="changeOvenTemp('${ovenName}', this.value)">
                            <option value="850" ${curTemp=='850'?'selected':''}>850¬∞C</option>
                            <option value="600" ${curTemp=='600'?'selected':''}>600¬∞C</option>
                        </select>
                    </td>

                    <td>
                        <div class="task-cell">
                            <input type="checkbox" ${itemVS.completed ? 'checked' : ''}
                                onchange="toggleMaint('${pathVS}', this.checked)">
                            <input type="date" class="${itemVS.completed ? '' : 'hidden-date'}"
                                value="${itemVS.date || ''}" onchange="updateMaintDate('${pathVS}', this.value)">
                        </div>
                    </td>

                    <td>
                        <div class="task-cell">
                            <input type="checkbox" ${itemPF.completed ? 'checked' : ''}
                                onchange="toggleMaint('${pathPF}', this.checked)">
                            <input type="date" class="${itemPF.completed ? '' : 'hidden-date'}"
                                value="${itemPF.date || ''}" onchange="updateMaintDate('${pathPF}', this.value)">
                        </div>
                    </td>

                    <td>
                        <input type="text" class="note-input" value="${noteContent}"
                            placeholder="Nh·∫≠p ghi ch√∫..." onblur="updateOvenNote('${ovenName}', this.value)">
                    </td>
                </tr>`;
            });

            // 2. Dakuto & BƒÉng t·∫£i
            let dPath6 = `dakuto.${viewYear}.06`;
            let item6 = safeGet(data, dPath6) || { completed: false, date: null };
            let dPath12 = `dakuto.${viewYear}.12`;
            let item12 = safeGet(data, dPath12) || { completed: false, date: null };

            // T√≠nh to√°n ng√†y ƒëo bƒÉng t·∫£i
            const targetSaturdays = getTargetSaturdays(parseInt(viewYear), parseInt(viewMonth));
            const saturdayDisplay = targetSaturdays.length > 0 ? targetSaturdays.join(', ') : 'Kh√¥ng c√≥';

            // T√≠nh to√°n th·ªëng k√™
            const stats = calculateMaintenanceStats(data, viewYear, viewMonth);

            html += `<tr style="border-top: 2px solid #ccc; background:#f0f8ff;">
                <td colspan="2" style="font-weight:bold;">KH√ÅC</td>
                <td>
                    <div style="font-weight:bold; margin-bottom:5px;">V·ªá sinh Dakuto (T6 & T12)</div>
                    <div class="task-cell" style="margin-bottom:5px;">
                        <span>T6:</span>
                        <input type="checkbox" ${item6.completed?'checked':''} onchange="toggleMaint('${dPath6}', this.checked)">
                        <input type="date" class="${item6.completed?'':'hidden-date'}" value="${item6.date||''}" onchange="updateMaintDate('${dPath6}', this.value)">
                    </div>
                    <div class="task-cell">
                        <span>T12:</span>
                        <input type="checkbox" ${item12.completed?'checked':''} onchange="toggleMaint('${dPath12}', this.checked)">
                        <input type="date" class="${item12.completed?'':'hidden-date'}" value="${item12.date||''}" onchange="updateMaintDate('${dPath12}', this.value)">
                    </div>
                </td>
                <td style="background:#fff3cd; border: 1px solid #ffc107;">
                    <div style="font-weight:bold; margin-bottom:5px; color: #856404;">L·ªäCH ƒêO BƒÇNG T·∫¢I</div>
                    <div>Th·ª© 7 tu·∫ßn 1 & 3 c·ªßa th√°ng ${viewMonth}:</div>
                    <div style="font-weight:bold; color: var(--primary); font-size: 16px;">${saturdayDisplay}</div>
                </td>

                <td style="background:#e9f7ef; border: 1px solid #28a745; color: #155724;">
                    <div style="font-weight:bold; margin-bottom:5px;">TH·ªêNG K√ä HO√ÄN TH√ÄNH</div>
                    <div>V·ªá sinh: <b>${stats.vesinhCompleted} / ${stats.totalOvens}</b> L√≤</div>
                    <div>ƒêo Profile: <b>${stats.profileCompleted} / ${stats.totalOvens}</b> L√≤</div>
                </td>
            </tr>`;

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function toggleMaint(path, checked) {
            const today = new Date().toISOString().slice(0,10);

            // X√¢y d·ª±ng object update cho Firebase (v√≠ d·ª•: ovens.L√≤ 1.850.V·ªá sinh.2025.11)
            const parts = path.split('.');
            let updateObject = {};
            // L·∫•y 4 ph·∫ßn ƒë·∫ßu ti√™n (v√≠ d·ª•: ovens.L√≤ 1.850.V·ªá sinh)
            let basePath = parts.slice(0, 4).join('.');
            // Th√™m ph·∫ßn nƒÉm v√† th√°ng ƒë·ªÉ t·∫°o path cu·ªëi c√πng (v√≠ d·ª•: ovens.L√≤ 1.850.V·ªá sinh.2025.11)
            let fullPath = `${basePath}.${viewYear}.${viewMonth}`;

            updateObject[fullPath] = { completed: checked, date: checked ? today : null };

            await db.collection('maintenance').doc('schedules').update(updateObject);
            // onSnapshot s·∫Ω t·ª± ƒë·ªông k√≠ch ho·∫°t renderMaintenanceUI
        }

        async function updateMaintDate(path, newDate) {
            // X√¢y d·ª±ng path ƒë·∫ßy ƒë·ªß bao g·ªìm nƒÉm v√† th√°ng (v√≠ d·ª•: ovens.L√≤ 1.850.V·ªá sinh.2025.11.date)
            let fullPath = `${path}.${viewYear}.${viewMonth}.date`;
            await db.collection('maintenance').doc('schedules').update({ [fullPath]: newDate });
        }

        async function updateOvenNote(ovenName, content) {
            const path = `ovens.${ovenName}.notes.${viewYear}.${viewMonth}`;
            await db.collection('maintenance').doc('schedules').update({ [path]: content });
        }

        async function hardResetMaintenance() {
            if(!confirm("C·∫¢NH B√ÅO: D·ªØ li·ªáu c≈© s·∫Ω b·ªã m·∫•t. B·∫°n c√≥ ch·∫Øc kh√¥ng?")) return;
            await db.collection('maintenance').doc('schedules').delete();
            // Kh·ªüi t·∫°o l·∫°i d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
            await db.collection('maintenance').doc('schedules').set({ ovenTemps: ovenTemps });
            // Sau khi x√≥a v√† set l·∫°i, onSnapshot s·∫Ω t·ª± ƒë·ªông k√≠ch ho·∫°t render l·∫°i UI
        }

    </script>
</body>
</html>