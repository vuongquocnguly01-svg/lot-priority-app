<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Lot & B·∫£o Tr√¨ - Fixed Version</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- GIAO DI·ªÜN C∆† B·∫¢N --- */
        :root {
            --primary: #007bff; --success: #28a745; --danger: #dc3545;
            --text: #333; --bg: #f4f6f9; --border: #dee2e6;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 20px; display: flex; justify-content: center; }

        /* --- KHUNG ƒêƒÇNG NH·∫¨P --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 8px; width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }

        /* --- GIAO DI·ªÜN CH√çNH --- */
        #main-app { display: none; width: 100%; max-width: 1380px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); font-size: 24px; }

        /* --- N√öT B·∫§M & INPUT --- */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .search-box { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 300px; }

        /* --- B·∫¢NG D·ªÆ LI·ªÜU LOT --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        th { background: var(--primary); color: white; text-transform: uppercase; font-size: 13px; }
        td input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }

        /* --- TR·∫†NG TH√ÅI --- */
        .status-select { padding: 5px; border-radius: 4px; font-weight: bold; border: 1px solid #ccc; }
        .st-pending { color: orange; border-color: orange; }
        .st-running { color: var(--primary); border-color: var(--primary); }
        .st-done { color: var(--success); border-color: var(--success); }

        /* --- FORM TH√äM LOT --- */
        #add-lot-form { display: none; background: var(--bg); padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); }
        #add-lot-form textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 8px; }

        /* --- PH·∫¶N B·∫¢O TR√å (C·∫¢I TI·∫æN) --- */
        .maintenance-section { margin-top: 40px; border-top: 2px dashed var(--border); padding-top: 20px; }
        .maintenance-controls { display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .maintenance-controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; font-weight: bold; }

        /* Style cho √¥ b·∫£o tr√¨ thu g·ªçn */
        .task-cell { display: flex; align-items: center; gap: 8px; }
        .task-cell input[type="date"] {
            border: 1px solid #ddd; padding: 3px; border-radius: 4px; font-size: 12px;
            width: 110px; transition: 0.2s;
        }
        .hidden-date { opacity: 0; pointer-events: none; width: 0 !important; padding: 0 !important; border: none !important; }

        /* Style cho √¥ ghi ch√∫ */
        .note-input { width: 100%; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .note-input:focus { border-color: var(--primary); outline: none; }

        /* --- TI·ªÜN √çCH --- */
        .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }
        .error-display { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; display: none; }

        /* --- PH·∫¶N S·∫¢N L∆Ø·ª¢NG M·ªöI (ƒê√£ c·∫≠p nh·∫≠t) --- */
        .production-section { margin-top: 40px; border-top: 2px dashed #007bff; padding-top: 20px; }
        .prod-input-group input, .prod-input-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* FIX C√ÇN ƒê·ªêI B·ªê C·ª§C 3 B·∫¢NG (ƒê√É C·∫¨P NH·∫¨T ƒê·ªÇ T√ÅCH BI·ªÜT R√ï R√ÄNG) */
        #productionStatsContainer {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        #productionStatsContainer > div {
             flex: 1 1 100%;
             min-width: 300px;
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             background: white;
             display: flex;
             flex-direction: column;
             margin-bottom: 20px;
        }

        /* B·∫£ng th·ªëng k√™ m·ªõi */
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        /* TƒÉng padding cho c·ªôt m·ªõi */
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; text-align: right; }
        .stats-table th { background: #e9f7ef; font-weight: bold; text-align: center; }
        .stats-table .person-col { text-align: left; font-weight: bold; background: #f8f9fa; }
        .stats-table .total-col { background: #fff3cd; font-weight: bold; color: #856404; }
        .stats-table .grand-total-row th { background: var(--success); color: white; text-align: right; }
        .stats-table .grand-total-row td { background: var(--success); color: white; font-weight: bold; }

        /* C·∫≠p nh·∫≠t m√†u s·∫Øc cho c√°c c·ªôt c√¥ng ƒëo·∫°n */
        .process-cell {
            font-weight: bold;
            text-align: right;
            transition: background-color 0.3s;
            color: #333;
        }
        .color-UC { background-color: #e6f7ff !important; } /* Light Blue */
        .color-C { background-color: #f0fff0 !important; } /* Light Green */
        .color-R { background-color: #fff4e6 !important; } /* Light Orange */
        .color-T1 { background-color: #f7e6ff !important; } /* Light Purple */
        .color-T2 { background-color: #ffe6e6 !important; } /* Light Red */
        .color-T3 { background-color: #e6ffe6 !important; } /* Dark Green */
        .color-CLF { background-color: #f3f3f3 !important; } /* Light Gray */
        .color-G1 { background-color: #f0f0ff !important; } /* Indigo */
        .color-GH { background-color: #fffae6 !important; } /* Gold */
        .color-default { background-color: #f5f5f5 !important; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>ƒêƒÉng Nh·∫≠p</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button id="login-btn">V√ÄO H·ªÜ TH·ªêNG</button>
        <p id="login-msg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
    </div>
</div>

<div id="main-app">
    <header>
        <h1>QU·∫¢N L√ù LOT ∆ØU TI√äN</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-danger" id="logout-btn">ƒêƒÉng xu·∫•t</button>
        </div>
    </header>

    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <input type="text" class="search-box" id="searchInput" placeholder="T√¨m s·ªë Lot ho·∫∑c Keijo..."
               onkeyup="renderLotsTable()">
        <div>
            <button class="btn btn-danger" id="btnDeleteMulti" onclick="deleteSelected()"
                    style="display:none; margin-right: 10px;">X√≥a ƒë√£ ch·ªçn
            </button>
            <button class="btn btn-success" onclick="toggleAddForm()">+ Th√™m Lot M·ªõi</button>
        </div>
    </div>

    <div id="add-lot-form">
        <h3>Th√™m nhanh (Copy t·ª´ Excel)</h3>
        <textarea id="inputLotData"
                  placeholder="D√°n d·ªØ li·ªáu: Lot  Keijo  ƒêi·ªánTr·ªü (M·ªói d√≤ng 1 lot) VD: CKP6A0000 Z18 332"></textarea>
        <select id="inputProcess" style="padding: 8px; width: 200px; margin-bottom: 10px;">
            <option value="">-- Ch·ªçn C√¥ng ƒêo·∫°n --</option>
            <option value="UC">UC</option>
            <option value="C">C</option>
            <option value="R">R</option>
            <option value="T1">T1</option>
            <option value="CLF">CLF</option>
            <option value="T2">T2</option>
            <option value="T3">T3</option>
            <option value="G1">G1</option>
            <option value="GH">GH</option>
        </select>
        <br>
        <button class="btn btn-primary" onclick="submitNewLots()">L∆∞u D·ªØ Li·ªáu</button>
        <button class="btn btn-danger" onclick="toggleAddForm()">H·ªßy</button>
    </div>

    <table>
        <thead>
        <tr>
            <th style="width: 40px;"><input type="checkbox" id="checkAll" onchange="toggleSelectAll()"></th>
            <th>STT</th>
            <th>Lot</th>
            <th>Keijo</th>
            <th>ƒêi·ªán tr·ªü</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Gi·ªù ra l√≤</th>
            <th>C√¥ng ƒëo·∫°n</th>
            <th>Ghi ch√∫</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="lotTableBody"></tbody>
    </table>

    <div style="margin-top: 15px; text-align: right;">
        <span id="pagingInfo"></span>
        <button class="btn btn-primary" onclick="prevPage()"> <</button>
        <button class="btn btn-primary" onclick="nextPage()"> ></button>
    </div>

    <div class="maintenance-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>üõ† L·ªäCH S·ª¨ B·∫¢O TR√å</h2>

            <div class="maintenance-controls">
                <span>Xem d·ªØ li·ªáu:</span>
                <select id="viewMonth" onchange="changeViewDate()"></select>
                <select id="viewYear" onchange="changeViewDate()"></select>
                <button class="btn btn-outline" onclick="jumpToNow()">V·ªÅ hi·ªán t·∫°i</button>
            </div>
        </div>

        <div id="maintenanceError" class="error-display">
            C√≥ l·ªói t·∫£i d·ªØ li·ªáu.
            <button class="btn btn-danger" onclick="hardResetMaintenance()">Kh√¥i ph·ª•c d·ªØ li·ªáu g·ªëc</button>
        </div>

        <div id="maintenanceLoading" class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu b·∫£o tr√¨...</div>
        <div id="maintenanceContent" style="display: none;">
        </div>
    </div>

    <div class="production-section">
        <h2>üìà PH√ÇN T√çCH S·∫¢N L∆Ø·ª¢NG THEO C√îNG ƒêO·∫†N (ƒê∆°n v·ªã: T·∫•m)</h2>
        <div style="padding: 15px; border: 1px solid var(--primary); border-radius: 8px; background: #f0f8ff;">

            <p style="font-weight: bold; margin-bottom: 10px;">B∆∞·ªõc 1: C·∫•u H√¨nh C·ªôt (K√Ω t·ª± c·ªôt ph·∫£i t∆∞∆°ng ·ª©ng gi·ªØa 2
                file)</p>
            <div class="prod-input-group"
                 style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px;">
                <label>C·ªôt S·∫£n L∆∞·ª£ng:</label>
                <input type="text" id="colProdInput" placeholder="K√Ω t·ª± c·ªôt (v√≠ d·ª•: H)" value="H" style="width: 130px;">

                <label>C·ªôt Ng∆∞·ªùi TH:</label>
                <input type="text" id="colPersonInput" placeholder="K√Ω t·ª± c·ªôt (v√≠ d·ª•: R)" value="R"
                       style="width: 130px;">

                <label>C·ªôt C√¥ng ƒêo·∫°n:</label>
                <input type="text" id="colProcessInput" placeholder="K√Ω t·ª± c·ªôt (v√≠ d·ª•: B)" value="B"
                       style="width: 130px;">

                <label>C·ªôt Ng√†y Th√°ng:</label>
                <input type="text" id="colDateInput" placeholder="K√Ω t·ª± c·ªôt (v√≠ d·ª•: A)" value="A" style="width: 130px;">

                <label>D√≤ng Ti√™u ƒê·ªÅ (S·ªë d√≤ng):</label>
                <input type="number" id="headerRowInput" placeholder="VD: 3" value="3" min="1" style="width: 130px;">
            </div>

            <hr style="margin: 15px 0; border-top: 1px dashed #ccc;">

            <p style="font-weight: bold; margin-bottom: 10px;">B∆∞·ªõc 2: T·∫£i File (C√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c)</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; border: 1px dashed green; padding: 10px; border-radius: 5px;">
                    <label style="font-weight: bold; color: green;">File ƒê·∫ßu V√ÄO (IN):</label>
                    <input type="file" id="inputFileInput" onchange="handleFileSelection(event, 'IN')" multiple>
                    <div id="fileList_IN" style="font-size: 12px; margin-top: 5px; color: #555;">Ch∆∞a ch·ªçn file.</div>
                </div>
                <div style="flex: 1; border: 1px dashed blue; padding: 10px; border-radius: 5px;">
                    <label style="font-weight: bold; color: blue;">File ƒê·∫ßu RA (OUT):</label>
                    <input type="file" id="outputFileInput" onchange="handleFileSelection(event, 'OUT')" multiple>
                    <div id="fileList_OUT" style="font-size: 12px; margin-top: 5px; color: #555;">Ch∆∞a ch·ªçn file.</div>
                </div>
            </div>

            <div id="excelError" style="color: var(--danger); margin-top: 10px; font-weight: bold;"></div>

            <hr style="margin: 15px 0; border-top: 1px dashed #ccc;">

            <p style="font-weight: bold; margin-bottom: 10px;">B∆∞·ªõc 3: T√≠nh To√°n & Xu·∫•t B√°o C√°o</p>
            <div class="prod-input-group" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <label>Th√°ng/NƒÉm C·∫ßn T√≠nh:</label>
                <select id="prodMonth" style="width: 80px;"></select>
                <select id="prodYear" style="width: 100px;"></select>

                <label>T√™n Ng∆∞·ªùi:</label>
                <select id="personSelect" style="width: 150px;">
                    <option value="all">-- T·∫•t C·∫£ M·ªçi Ng∆∞·ªùi --</option>
                </select>

                <button class="btn btn-success" onclick="calculateProduction()">üí∞ T√çNH T·ªîNG S·∫¢N L∆Ø·ª¢NG</button>
                <button class="btn btn-primary" id="exportBtn" onclick="exportToExcel()" style="display: none;">üìä XU·∫§T
                    FILE EXCEL
                </button>
                <button class="btn btn-primary" id="captureBtn" onclick="captureAndDownloadStats()"
                        style="display: none;">üì∏ CH·ª§P ·∫¢NH K·∫æT QU·∫¢
                </button>
            </div>
        </div>

        <div id="productionStatsContainer" style="display: none;">
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // 1. C·∫§U H√åNH FIREBASE & DISCORD
   const firebaseConfig = {
     apiKey: "AIzaSyCn866gY_3OiB_VL0fUDMe3ZCdhYDRbIJ8",
     authDomain: "lot-priority-app-shared.firebaseapp.com",
     projectId: "lot-priority-app-shared",
     storageBucket: "lot-priority-app-shared.firebasestorage.app",
     messagingSenderId: "12749059268",
     appId: "1:12749059268:web:e1aa877135d8741461c591",
     measurementId: "G-DPNT9PZ61Y"
   };

    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1377130413708808272/BH7cEuL4lWI6C-FfhNGnl84kgZ_LnqWn8TVIY8uuesT69PzrXuxZ60Uv4Tm1TFMW9BdC";

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. BI·∫æN TO√ÄN C·ª§C
    let rawLots = [];
    let selectedIds = [];
    let curPage = 1;
    const pageSize = 10;

    let viewYear = new Date().getFullYear();
    let viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
    let maintenanceDataCache = {};

    // BI·∫æN CHO S·∫¢N L∆Ø·ª¢NG
    let inputFiles = []; // Danh s√°ch file ƒê·∫ßu V√ÄO
    let outputFiles = []; // Danh s√°ch file ƒê·∫ßu RA
    let allInputData = []; // D·ªØ li·ªáu ƒë√£ combine c·ªßa ƒê·∫ßu V√ÄO
    let allOutputData = []; // D·ªØ li·ªáu ƒë√£ combine c·ªßa ƒê·∫ßu RA

    let inputColMap = {}; // Map k√Ω t·ª± c·ªôt (A, B) v·ªõi t√™n Header cho file IN
    let outputColMap = {}; // Map k√Ω t·ª± c·ªôt (A, B) v·ªõi t√™n Header cho file OUT
    let processList = new Set(); // Danh s√°ch c√¥ng ƒëo·∫°n duy nh·∫•t

    // Map process name to a specific color class
    const PROCESS_COLORS = {
        'UC': 'color-UC', 'C': 'color-C', 'R': 'color-R', 'T1': 'color-T1',
        'CLF': 'color-CLF', 'T2': 'color-T2', 'T3': 'color-T3', 'G1': 'color-G1', 'GH': 'color-GH',
    };
    function getColorClass(processName) {
        if (!processName) return 'color-default';
        const key = processName.toUpperCase().replace(/[^A-Z0-9]/g, '');
        return PROCESS_COLORS[key] || 'color-default';
    }

    const OVEN_LIST = [1,2,3,4,5,6,7];
    let ovenTemps = { 'L√≤ 1': '850', 'L√≤ 2': '850', 'L√≤ 3': '850', 'L√≤ 4': '850', 'L√≤ 5': '850', 'L√≤ 6': '850', 'L√≤ 7': '850' };

    // --- H√ÄM G·ª¨I DISCORD ---
    function sendDiscordNotification(message) {
        if(!DISCORD_WEBHOOK_URL) {
            console.warn("Ch∆∞a c·∫•u h√¨nh URL Discord");
            return;
        }

        console.log("ƒêang g·ª≠i Discord:", message);

        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: message })
        })
        .then(response => {
            if(response.ok) console.log("G·ª≠i Discord th√†nh c√¥ng");
            else console.error("L·ªói g·ª≠i Discord:", response.status);
        })
        .catch(err => {
            console.error("L·ªói m·∫°ng g·ª≠i Discord:", err);
        });
    }

    // --- H√ÄM T√çNH TO√ÅN NG√ÄY TH·ª® 7 TU·∫¶N 1 & 3 ---
    function getTargetSaturdays(year, month) {
        const dates = [];
        const date = new Date(year, month - 1, 1);
        let saturdayCount = 0;

        while (date.getMonth() === (month - 1)) {
            if (date.getDay() === 6) { // Th·ª© 7 (Saturday)
                saturdayCount++;
                if (saturdayCount === 1 || saturdayCount === 3) {
                    dates.push(new Date(date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                }
            }
            date.setDate(date.getDate() + 1);
        }
        return dates;
    }

    // --- H√ÄM T√çNH TO√ÅN TH·ªêNG K√ä HO√ÄN TH√ÄNH ---
    function calculateMaintenanceStats(data, year, month) {
        let stats = {
            vesinhCompleted: 0,
            profileCompleted: 0,
            totalOvens: OVEN_LIST.length
        };

        OVEN_LIST.forEach(id => {
            const ovenName = `L√≤ ${id}`;
            const curTemp = ovenTemps[ovenName] || '850';

            // Check V·ªá sinh
            let pathVS = `ovens.${ovenName}.${curTemp}.V·ªá sinh.${year}.${month}.completed`;
            if (safeGet(data, pathVS) === true) {
                stats.vesinhCompleted++;
            }

            // Check ƒêo Profile
            let pathPF = `ovens.${ovenName}.${curTemp}.ƒêo Profile.${year}.${month}.completed`;
            if (safeGet(data, pathPF) === true) {
                stats.profileCompleted++;
            }
        });

        return stats;
    }

    // 3. KH·ªûI T·∫†O MENU TH·ªúI GIAN (ƒê√É S·ª¨A: M·ªû R·ªòNG PH·∫†M VI NƒÇM)

    // --- THAY TH·∫æ H√ÄM KH·ªûI T·∫†O DATE CONTROLS ---
     async function loadUserMaintSettings(user) {
         try {
              const docRef = db.collection('user_settings').doc(user.uid);
              const doc = await docRef.get();
              if (doc.exists && doc.data().maintView) {
                 // C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c v·ªõi gi√° tr·ªã ƒë√£ l∆∞u
                 viewMonth = doc.data().maintView.month || viewMonth;
                 viewYear = doc.data().maintView.year || viewYear;
              }
         } catch (e) {
             console.error("L·ªói t·∫£i ng√†y xem b·∫£o tr√¨:", e);
         }
         // Ph·∫£i g·ªçi initDateControls SAU khi ƒë√£ c√≥ d·ªØ li·ªáu t·ª´ Firebase
         initDateControls();
    }

    function initDateControls() {
       // viewMonth v√† viewYear ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p b·ªüi loadUserMaintSettings ho·∫∑c m·∫∑c ƒë·ªãnh

        const selM = document.getElementById('viewMonth');
        const selY = document.getElementById('viewYear');

        selM.innerHTML = '';
        for(let i=1; i<=12; i++) selM.innerHTML += `<option value="${String(i).padStart(2, '0')}">Th√°ng ${i}</option>`;

        selY.innerHTML = '';
        const currentY = new Date().getFullYear();
        for(let i = currentY - 1; i <= currentY + 50; i++) selY.innerHTML += `<option value="${i}">NƒÉm ${i}</option>`;

        // G√°n l·∫°i gi√° tr·ªã viewMonth/viewYear ƒë√£ ƒë∆∞·ª£c l·∫•y t·ª´ Firebase (ho·∫∑c m·∫∑c ƒë·ªãnh)
        selM.value = viewMonth;
        selY.value = viewYear;
    }

    // --- H√ÄM KH·ªûI T·∫†O CONTROL CHO S·∫¢N L∆Ø·ª¢NG (ƒê√É S·ª¨A: M·ªû R·ªòNG PH·∫†M VI NƒÇM) ---
    function initProdDateControls() {
        const selM = document.getElementById('prodMonth');
        const selY = document.getElementById('prodYear');
        const currentY = new Date().getFullYear();
        const currentM = String(new Date().getMonth() + 1).padStart(2, '0');
        const maxFutureYear = currentY + 50; // Ph·∫°m vi v√¥ t·∫≠n (50 nƒÉm)

        selM.innerHTML = '';
        for(let i=1; i<=12; i++) selM.innerHTML += `<option value="${String(i).padStart(2, '0')}">T${i}</option>`;

        selY.innerHTML = '';
        // Thay ƒë·ªïi ph·∫°m vi nƒÉm: Hi·ªán t·∫°i ƒë·∫øn Hi·ªán t·∫°i + 50 (M√¥ ph·ªèng "V√¥ T·∫≠n")
        for(let i = currentY; i <= maxFutureYear; i++) {
            selY.innerHTML += `<option value="${i}">NƒÉm ${i}</option>`;
        }

        selM.value = currentM;
        // ƒê·∫∑t nƒÉm m·∫∑c ƒë·ªãnh l√† nƒÉm hi·ªán t·∫°i
        selY.value = currentY;
    }

    function jumpToNow() {
        viewYear = new Date().getFullYear();
        viewMonth = String(new Date().getMonth() + 1).padStart(2, '0');
        document.getElementById('viewMonth').value = viewMonth;
        document.getElementById('viewYear').value = viewYear;

       // THAY ƒê·ªîI: L∆ØU V√ÄO FIREBASE
       const user = auth.currentUser;
       if (user) {
            db.collection('user_settings').doc(user.uid).set({
                maintView: { month: viewMonth, year: viewYear }
            }, { merge: true }).catch(e => console.error("L·ªói l∆∞u c√†i ƒë·∫∑t Firebase:", e));
       }

       if (Object.keys(maintenanceDataCache).length > 0) renderMaintenanceUI(maintenanceDataCache);
    }

    function changeViewDate() {
        viewMonth = document.getElementById('viewMonth').value;
        viewYear = document.getElementById('viewYear').value;

       // THAY ƒê·ªîI: L∆ØU V√ÄO FIREBASE
       const user = auth.currentUser;
       if (user) {
           db.collection('user_settings').doc(user.uid).set({
              maintView: { month: viewMonth, year: viewYear }
           }, { merge: true }).catch(e => console.error("L·ªói l∆∞u c√†i ƒë·∫∑t Firebase:", e));
       }

       if (Object.keys(maintenanceDataCache).length > 0) renderMaintenanceUI(maintenanceDataCache);
    }

    // 4. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P & NOTIFICATION DISCORD
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            // --- LOGIC TH√îNG B√ÅO DISCORD KHI ƒêƒÇNG NH·∫¨P ---
            // S·ª≠ d·ª•ng sessionStorage ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ th√¥ng b√°o 1 l·∫ßn m·ªói phi√™n l√†m vi·ªác (tr√°nh F5 spam)
            if (!sessionStorage.getItem('logged_in_session')) {
                const statsRef = db.collection('system_stats').doc('login_counter');

                // S·ª≠ d·ª•ng Atomic Increment ƒë·ªÉ tƒÉng bi·∫øn ƒë·∫øm an to√†n
                statsRef.set({
                    count: firebase.firestore.FieldValue.increment(1),
                    last_login: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true })
                .then(() => statsRef.get())
                .then(doc => {
                    const count = doc.data().count;
                    const email = user.email ? user.email.split('@')[0] : "User";

                    // G·ª≠i th√¥ng b√°o Discord
                    sendDiscordNotification(`üîî **TH√îNG B√ÅO ƒêƒÇNG NH·∫¨P**\nüë§ User: **${email}**\nüî¢ L∆∞·ª£t ƒëƒÉng nh·∫≠p h·ªá th·ªëng th·ª©: **${count}**\nüïí Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}`);

                    // ƒê√°nh d·∫•u ƒë√£ th√¥ng b√°o trong phi√™n n√†y
                    sessionStorage.setItem('logged_in_session', 'true');
                })
                .catch(err => {
                    console.error("L·ªói c·∫≠p nh·∫≠t th·ªëng k√™ ƒëƒÉng nh·∫≠p:", err);
                });
            }
            // --- K·∫æT TH√öC LOGIC DISCORD ---

            loadUserMaintSettings(user).then(() => {
               initProdDateControls();
               initApp();
            });
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            sessionStorage.removeItem('logged_in_session'); // Reset c·ªù khi ƒëƒÉng xu·∫•t
        }
    });

    // H√†m g·ªçi khi b·∫•m n√∫t ƒëƒÉng nh·∫≠p
    async function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value;
        const msgEl = document.getElementById('login-msg');
        msgEl.innerText = ''; // X√≥a th√¥ng b√°o c≈©

        if (!u || !p) {
            msgEl.innerText = "‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß T√™n ƒëƒÉng nh·∫≠p v√† M·∫≠t kh·∫©u.";
            return;
        }

        try {
            // T·ª± ƒë·ªông th√™m domain email ƒë·ªÉ ƒëƒÉng nh·∫≠p
            await auth.signInWithEmailAndPassword(`${u}@lot-priority-app-shared.com`, p);
        }
        catch (e) {
            console.error("L·ªói ƒêƒÉng nh·∫≠p:", e.code, e.message);
            if (e.code === 'auth/wrong-password') {
                msgEl.innerText = "‚ùå Sai m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.";
            } else if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-email') {
                msgEl.innerText = "‚ùå T√™n ƒëƒÉng nh·∫≠p kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i.";
            } else {
                msgEl.innerText = "‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh. Ki·ªÉm tra Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.";
            }
        }
    }
    // H√†m g·ªçi khi b·∫•m n√∫t ƒëƒÉng xu·∫•t
    function handleLogout() { auth.signOut(); }

    // 5. LOGIC H·ªÜ TH·ªêNG CHUNG
    function initApp() {
        db.collection('lots').onSnapshot(snap => {
            rawLots = [];
            snap.forEach(doc => rawLots.push({id: doc.id, ...doc.data()}));
            rawLots.sort((a, b) => {
                const score = s => s === 'ƒêang nung' ? 0 : (s === 'Ch·ªù x·ª≠ l√Ω' ? 1 : 2);
                return score(a.status) - score(b.status) || (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
            });
            renderLotsTable();
        });

        db.collection('maintenance').doc('schedules').onSnapshot(doc => {
            const docData = doc.exists ? doc.data() : {};
            maintenanceDataCache = docData;

            const defaultTemps = { 'L√≤ 1': '850', 'L√≤ 2': '850', 'L√≤ 3': '850', 'L√≤ 4': '850', 'L√≤ 5': '850', 'L√≤ 6': '850', 'L√≤ 7': '850' };
            ovenTemps = docData.ovenTemps ? { ...defaultTemps, ...docData.ovenTemps } : defaultTemps;

            if (!maintenanceDataCache.ovens) maintenanceDataCache.ovens = {};
            if (!maintenanceDataCache.dakuto) maintenanceDataCache.dakuto = {};

            renderMaintenanceUI(maintenanceDataCache);
        }, (error) => {
            console.error("L·ªói l·∫Øng nghe Firebase:", error);
            document.getElementById('maintenanceError').style.display = 'block';
            document.getElementById('maintenanceLoading').style.display = 'none';
        });

        // --- RESET BI·∫æN C·∫§U H√åNH V√Ä D·ªÆ LI·ªÜU CHO PH·∫¶N S·∫¢N L∆Ø·ª¢NG KHI KH·ªûI T·∫†O APP ---
        inputColMap = {};
        outputColMap = {};
        allInputData = [];
        allOutputData = [];
        inputFiles = [];
        outputFiles = [];
        processList = new Set();
        // --- H·∫æT RESET ---

        checkConveyorReminder();
        initProdDateControls();
        // Kh·ªüi t·∫°o hi·ªÉn th·ªã tr·∫°ng th√°i file
        document.getElementById('fileList_IN').innerHTML = '<span style="color:red;">Ch∆∞a ch·ªçn file.</span>';
        document.getElementById('fileList_OUT').innerHTML = '<span style="color:red;">Ch∆∞a ch·ªçn file.</span>';
    }


    // --- KI·ªÇM TRA NH·∫ÆC NH·ªû BƒÇNG T·∫¢I (Th·ª© 6 b√°o tr∆∞·ªõc 1 ng√†y) ---
    function checkConveyorReminder() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 5=Fri
        if (dayOfWeek !== 5) return;

        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const weekOfMonth = Math.ceil(tomorrow.getDate() / 7);

        if (weekOfMonth === 1 || weekOfMonth === 3) {
            const todayStr = today.toISOString().split('T')[0];
            const lastSent = localStorage.getItem('discord_conveyor_sent');

            if (lastSent !== todayStr) {
                sendDiscordNotification(`‚ö†Ô∏è **NH·∫ÆC NH·ªû B·∫¢O TR√å:**\nNg√†y mai (Th·ª© 7 - Tu·∫ßn ${weekOfMonth}) l√† l·ªãch **ƒêo t·ªëc ƒë·ªô bƒÉng t·∫£i**. Vui l√≤ng chu·∫©n b·ªã!`);
                localStorage.setItem('discord_conveyor_sent', todayStr);
            }
        }
    }

    function renderLotsTable() {
        const tbody = document.getElementById('lotTableBody');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));

        const total = filtered.length;
        const pages = Math.ceil(total / pageSize) || 1;
        if (curPage > pages) curPage = pages;
        const start = (curPage - 1) * pageSize;
        const displayLots = filtered.slice(start, start + pageSize);

        tbody.innerHTML = '';
        displayLots.forEach((item, idx) => {
            const stClass = item.status === 'ƒêang nung' ? 'st-running' : (item.status === 'Ch·ªù x·ª≠ l√Ω' ? 'st-pending' : 'st-done');
            const isChecked = selectedIds.includes(item.id) ? 'checked' : '';

            const row = `<tr>
                <td><input type="checkbox" ${isChecked} onchange="toggleOne('${item.id}')"></td>
                <td>${start + idx + 1}</td>
                <td contenteditable="true" onblur="updateCell('${item.id}', 'lot', this)">${item.lot}</td>
                <td contenteditable="true" onblur="updateCell('${item.id}', 'keijo', this)">${item.keijo}</td>
                <td contenteditable="true" onblur="updateCell('${item.id}', 'resistance', this)">${item.resistance}</td>
                <td>
                    <select class="status-select ${stClass}" onchange="changeStatus('${item.id}', this)">
                        <option value="Ch·ªù x·ª≠ l√Ω" ${item.status==='Ch·ªù x·ª≠ l√Ω'?'selected':''}>Ch·ªù x·ª≠ l√Ω</option>
                        <option value="ƒêang nung" ${item.status==='ƒêang nung'?'selected':''}>ƒêang nung</option>
                        <option value="Ho√†n th√†nh" ${item.status==='Ho√†n th√†nh'?'selected':''}>Ho√†n th√†nh</option>
                    </select>
                </td>
                <td><input type="datetime-local" value="${item.time || ''}" onchange="updateCell('${item.id}', 'time', this)"></td>
                <td contenteditable="true" onblur="updateCell('${item.id}', 'process', this)">${item.process}</td>
                <td contenteditable="true" onblur="updateCell('${item.id}', 'note', this)">${item.note || ''}</td>
                <td><button class="btn btn-danger" style="padding: 4px 8px;" onclick="deleteLot('${item.id}')">X√≥a</button></td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        document.getElementById('pagingInfo').innerText = `Trang ${curPage}/${pages}`;
        document.getElementById('btnDeleteMulti').style.display = selectedIds.length > 0 ? 'inline-block' : 'none';
        document.getElementById('btnDeleteMulti').innerText = `X√≥a (${selectedIds.length})`;
    }

    // 6. C√ÅC H√ÄM THAO T√ÅC LOT
    function updateCell(id, field, el) {
        let val = el.value !== undefined ? el.value : el.innerText;
        if(field === 'lot') val = val.toUpperCase();
        db.collection('lots').doc(id).update({ [field]: val });
    }

    function changeStatus(id, el) {
        const st = el.value;
        let updateData = { status: st };
        if(st === 'ƒêang nung') {
            const d = new Date();
            d.setMinutes(d.getMinutes() + 105);
            const iso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
            updateData.time = iso;
        }
        db.collection('lots').doc(id).update(updateData);
    }

    function toggleAddForm() {
        const f = document.getElementById('add-lot-form');
        f.style.display = f.style.display === 'block' ? 'none' : 'block';
    }

    async function submitNewLots() {
        const raw = document.getElementById('inputLotData').value;
        const proc = document.getElementById('inputProcess').value;
        if(!raw || !proc) return alert("Thi·∫øu d·ªØ li·ªáu!");

        const batch = db.batch();
        const lines = raw.split('\n');
        let count = 0;
        lines.forEach(line => {
            const parts = line.trim().split(/\s+/);
            if(parts.length >= 3) {
                const ref = db.collection('lots').doc();
                batch.set(ref, {
                    lot: parts[0].toUpperCase(),
                    keijo: parts[1],
                    resistance: parts[2],
                    process: proc,
                    status: 'Ch·ªù x·ª≠ l√Ω',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                count++;
            }
        });

        if(count > 0) {
            await batch.commit();
            // ƒê√£ x√≥a g·ª≠i Discord ·ªü ƒë√¢y theo y√™u c·∫ßu
            alert(`ƒê√£ th√™m ${count} lot.`);
            document.getElementById('inputLotData').value = '';
            toggleAddForm();
        } else {
            alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d√≤ng n√†o h·ª£p l·ªá!");
        }
    }

    // --- C·∫¨P NH·∫¨T: S·ª¨A L·ªñI X√ìA LOT ---
    async function confirmPass() {
          const user = auth.currentUser;
          // Ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ƒëang ƒëƒÉng nh·∫≠p kh√¥ng
          if (!user) {
            alert("‚ùå L·ªói: B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.");
             return false;
          }

        // Y√™u c·∫ßu nh·∫≠p m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p
        const pass = prompt("Nh·∫≠p M·∫¨T KH·∫®U ƒë·ªÉ x√≥a:");
        if (!pass) {
            alert("‚ùå ƒê√£ h·ªßy.");
            return false;
        }

       try {
               const email = user.email; // L·∫•y email c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i

               // 1. T·∫°o th√¥ng tin x√°c th·ª±c t·ª´ email v√† m·∫≠t kh·∫©u v·ª´a nh·∫≠p
              const credential = firebase.auth.EmailAuthProvider.credential(email, pass);

              // 2. Y√™u c·∫ßu Firebase x√°c th·ª±c l·∫°i (re-authenticate) ng∆∞·ªùi d√πng
              // Thao t√°c n√†y s·∫Ω th√†nh c√¥ng n·∫øu m·∫≠t kh·∫©u kh·ªõp, v√† th·∫•t b·∫°i n·∫øu sai.
              await user.reauthenticateWithCredential(credential);

              console.log("X√°c th·ª±c m·∫≠t kh·∫©u th√†nh c√¥ng. ƒêang ti·∫øn h√†nh x√≥a.");
              return true; // M·∫≠t kh·∫©u ƒë√∫ng
       }catch (e) {
               console.error("L·ªói x√°c th·ª±c l·∫°i:", e.code, e.message);
               let msg = "‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh. Vui l√≤ng ki·ªÉm tra Console (F12).";

               if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
               msg = "‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng ki·ªÉm tra l·∫°i.";
               }

               alert(msg);
               return false; // M·∫≠t kh·∫©u sai ho·∫∑c c√≥ l·ªói
       }
    }

    async function deleteLot(id) {
        if(await confirmPass()) {
            db.collection('lots').doc(id).delete()
            .then(() => {
                console.log("X√≥a th√†nh c√¥ng: " + id);
            })
            .catch((error) => {
                console.error("L·ªói x√≥a document: ", error);
                alert("‚ùå L·ªói: Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.");
            });
        }
    }

    async function deleteSelected() {
        if(selectedIds.length === 0) return;
        if(await confirmPass()) {
            const batch = db.batch();
            selectedIds.forEach(id => {
                batch.delete(db.collection('lots').doc(id));
            });
            batch.commit()
            .then(() => {
                sendDiscordNotification(`üóëÔ∏è **ƒê√£ x√≥a ${selectedIds.length} Lot kh·ªèi h·ªá th·ªëng!**`);
                selectedIds = [];
                renderLotsTable();
            })
            .catch((error) => {
                console.error("L·ªói x√≥a h√†ng lo·∫°t: ", error);
                alert("‚ùå L·ªói: Kh√¥ng th·ªÉ x√≥a h√†ng lo·∫°t. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }
    }

    function toggleSelectAll() {
        const isChecked = document.getElementById('checkAll').checked;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));

        selectedIds = [];
        if(isChecked) {
            filtered.forEach(l => selectedIds.push(l.id));
        }
        renderLotsTable();
    }

    function toggleOne(id) {
        const index = selectedIds.indexOf(id);
        if(index > -1) {
            selectedIds.splice(index, 1);
        } else {
            selectedIds.push(id);
        }
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i CheckAll
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));
        document.getElementById('checkAll').checked = selectedIds.length === filtered.length && filtered.length > 0;

        renderLotsTable();
    }

    function prevPage() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));
        const pages = Math.ceil(filtered.length / pageSize) || 1;
        if(curPage > 1) {
            curPage--;
            renderLotsTable();
        }
    }

    function nextPage() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = rawLots.filter(l => (l.lot||'').toLowerCase().includes(search) || (l.keijo||'').toLowerCase().includes(search));
        const pages = Math.ceil(filtered.length / pageSize) || 1;
        if (curPage < pages) {
            curPage++;
            renderLotsTable();
        }
    }

    // 7. H·ªÜ TH·ªêNG B·∫¢O TR√å (THU G·ªåN + GHI CH√ö)
    function safeGet(obj, path) {
        return path.split('.').reduce((acc, part) => acc && acc[part], obj);
    }

    // --- C·∫¨P NH·∫¨T: Thay th·∫ø localStorage b·∫±ng Firebase ---
    async function changeOvenTemp(ovenName, newTemp) {
        ovenTemps[ovenName] = newTemp;

        // C·∫≠p nh·∫≠t l√™n Firebase
        await db.collection('maintenance').doc('schedules').update({
            [`ovenTemps.${ovenName}`]: newTemp
        });
        // onSnapshot trong initApp s·∫Ω t·ª± ƒë·ªông render l·∫°i UI cho t·∫•t c·∫£ m√°y
    }

    function renderMaintenanceUI(data) {
const container = document.getElementById('maintenanceContent');
const uiLoading = document.getElementById('maintenanceLoading');
const uiContent = document.getElementById('maintenanceContent');

uiLoading.style.display = 'none';
uiContent.style.display = 'block';

let html = `<p style="font-style:italic; color:#666; margin-bottom:10px;">ƒêang xem d·ªØ li·ªáu: <b>Th√°ng ${viewMonth} / NƒÉm ${viewYear}</b></p>`;

html += `<table class="maintenance-table">
    <thead>
        <tr>
            <th style="width: 100px;">Thi·∫øt b·ªã</th>
            <th style="width: 100px;">Nhi·ªát ƒë·ªô</th>
            <th>V·ªá sinh (850 1T/L·∫¶N)</th>
            <th>ƒêo Profile (3T/L·∫¶N)</th>
            <th>Ghi ch√∫</th>
        </tr>
    </thead>
    <tbody>`;

// 1. RENDER L√í (OVEN)
OVEN_LIST.forEach(id => {
    const ovenName = `L√≤ ${id}`;
    // L·∫•y nhi·ªát ƒë·ªô ƒë√£ ƒë·ªìng b·ªô
    const curTemp = ovenTemps[ovenName] || '850';

    // T·∫°o ƒë∆∞·ªùng d·∫´n d·ªØ li·ªáu (Path)
    let pathVS = `ovens.${ovenName}.${curTemp}.V·ªá sinh.${viewYear}.${viewMonth}`;
    let itemVS = safeGet(data, pathVS) || { completed: false, date: null };

    let pathPF = `ovens.${ovenName}.${curTemp}.ƒêo Profile.${viewYear}.${viewMonth}`;
    let itemPF = safeGet(data, pathPF) || { completed: false, date: null };

    // L·∫•y ghi ch√∫
    let pathNote = `ovens.${ovenName}.notes.${viewYear}.${viewMonth}`;
    let noteContent = safeGet(data, pathNote) || "";

    html += `<tr>
        <td style="font-weight:bold; background:#f9f9f9;">${ovenName}</td>
        <td>
            <select onchange="changeOvenTemp('${ovenName}', this.value)">
                <option value="850" ${curTemp=='850'?'selected':''}>850¬∞C</option>
                <option value="600" ${curTemp=='600'?'selected':''}>600¬∞C</option>
            </select>
        </td>

        <td>
            <div class="task-cell">
                <input type="checkbox" ${itemVS.completed ? 'checked' : ''}
                    onchange="toggleMaint('${pathVS}', this.checked)">
                <input type="date" class="${itemVS.completed ? '' : 'hidden-date'}"
                    value="${itemVS.date || ''}" onchange="updateMaintDate('${pathVS}', this.value)">
            </div>
        </td>

        <td>
            <div class="task-cell">
                <input type="checkbox" ${itemPF.completed ? 'checked' : ''}
                    onchange="toggleMaint('${pathPF}', this.checked)">
                <input type="date" class="${itemPF.completed ? '' : 'hidden-date'}"
                    value="${itemPF.date || ''}" onchange="updateMaintDate('${pathPF}', this.value)">
            </div>
        </td>

        <td>
            <input type="text" class="note-input" value="${noteContent}"
                placeholder="Nh·∫≠p ghi ch√∫..." onblur="updateOvenNote('${ovenName}', this.value)">
        </td>
    </tr>`;
});

// 2. PH·∫¶N DAKUTO & BƒÇNG T·∫¢I (ƒê√£ ch·ªânh s·ª≠a ƒë·ªÉ kh·ªõp v·ªõi h√†m m·ªõi)
let dPath6 = `dakuto.${viewYear}.06`;
let item6 = safeGet(data, dPath6) || { completed: false, date: null };

let dPath12 = `dakuto.${viewYear}.12`;
let item12 = safeGet(data, dPath12) || { completed: false, date: null };

// T√≠nh to√°n ng√†y ƒëo bƒÉng t·∫£i
const targetSaturdays = getTargetSaturdays(parseInt(viewYear), parseInt(viewMonth));
const saturdayDisplay = targetSaturdays.length > 0 ? targetSaturdays.join(', ') : 'Kh√¥ng c√≥';

// T√≠nh to√°n th·ªëng k√™
const stats = calculateMaintenanceStats(data, viewYear, viewMonth);

html += `<tr style="border-top: 2px solid #ccc; background:#f0f8ff;">
    <td colspan="2" style="font-weight:bold;">KH√ÅC</td>
    <td>
        <div style="font-weight:bold; margin-bottom:5px;">V·ªá sinh Dakuto (T6 & T12)</div>

        <div class="task-cell" style="margin-bottom:5px;">
            <span>T6:</span>
            <input type="checkbox" ${item6.completed?'checked':''}
                onchange="toggleMaint('${dPath6}', this.checked)">
            <input type="date" class="${item6.completed?'':'hidden-date'}"
                value="${item6.date||''}" onchange="updateMaintDate('${dPath6}', this.value)">
        </div>

        <div class="task-cell">
            <span>T12:</span>
            <input type="checkbox" ${item12.completed?'checked':''}
                onchange="toggleMaint('${dPath12}', this.checked)">
            <input type="date" class="${item12.completed?'':'hidden-date'}"
                value="${item12.date||''}" onchange="updateMaintDate('${dPath12}', this.value)">
        </div>
    </td>

    <td style="background:#fff3cd; border: 1px solid #ffc107;">
        <div style="font-weight:bold; margin-bottom:5px; color: #856404;">L·ªäCH ƒêO BƒÇNG T·∫¢I</div>
        <div>Th·ª© 7 tu·∫ßn 1 & 3 c·ªßa th√°ng ${viewMonth}:</div>
        <div style="font-weight:bold; color: var(--primary); font-size: 16px;">${saturdayDisplay}</div>
    </td>

    <td style="background:#e9f7ef; border: 1px solid #28a745; color: #155724;">
        <div style="font-weight:bold; margin-bottom:5px;">TH·ªêNG K√ä HO√ÄN TH√ÄNH</div>
        <div>V·ªá sinh: <b>${stats.vesinhCompleted} / ${stats.totalOvens}</b> L√≤</div>
        <div>ƒêo Profile: <b>${stats.profileCompleted} / ${stats.totalOvens}</b> L√≤</div>
    </td>
</tr>`;

html += `</tbody></table>`;
container.innerHTML = html;

// X·ª≠ l√Ω ·∫©n/hi·ªán input date khi load xong (UI Init)
document.querySelectorAll('.maintenance-table input[type="checkbox"]').forEach(checkbox => {
    const dateInput = checkbox.closest('.task-cell').querySelector('input[type="date"]');
    if (dateInput) {
        if (checkbox.checked) {
            dateInput.classList.remove('hidden-date');
            dateInput.style.width = '110px';
            dateInput.style.padding = '3px';
            dateInput.style.border = '1px solid #ddd';
        } else {
             dateInput.classList.add('hidden-date');
        }
    }
});
}

    // H√ÄM CHUNG: C·∫≠p nh·∫≠t tr·∫°ng th√°i check
  async function toggleMaint(path, isCompleted) {
// path v√≠ d·ª•: "ovens.L√≤ 1.850.V·ªá sinh.2025.11" HO·∫∂C "dakuto.2025.06"
// Ch√∫ng ta d√πng tr·ª±c ti·∫øp path n√†y l√†m Key ƒë·ªÉ update, kh√¥ng c·∫ßn split/slice g√¨ c·∫£.

const updateData = {};
updateData[`${path}.completed`] = isCompleted;

// --- X·ª≠ l√Ω giao di·ªán √¥ ng√†y (Date Input) ---
// T√¨m √¥ input date n·∫±m c√πng d√≤ng v·ªõi checkbox v·ª´a b·∫•m
// L∆∞u √Ω: event.target l√† checkbox v·ª´a click
const checkbox = event.target;
const taskCell = checkbox.closest('.task-cell');
const dateInput = taskCell ? taskCell.querySelector('input[type="date"]') : null;

if (dateInput) {
    if (isCompleted) {
        // TR∆Ø·ªúNG H·ª¢P T√çCH CH·ªåN:

        // 1. Hi·ªán √¥ input
        dateInput.classList.remove('hidden-date');
        dateInput.style.width = '110px';
        dateInput.style.padding = '3px';
        dateInput.style.border = '1px solid #ddd';

        // 2. N·∫øu ch∆∞a c√≥ ng√†y, t·ª± ƒëi·ªÅn ng√†y h√¥m nay
        if (!dateInput.value) {
            // L·∫•y ng√†y hi·ªán t·∫°i theo gi·ªù ƒë·ªãa ph∆∞∆°ng (tr√°nh b·ªã l·ªách sang h√¥m tr∆∞·ªõc do m√∫i gi·ªù)
            const today = new Date();
            const localISODate = new Date(today.getTime() - (today.getTimezoneOffset() * 60000))
                                .toISOString().slice(0, 10);
            dateInput.value = localISODate;
        }

        // 3. L∆∞u ng√†y v√†o d·ªØ li·ªáu ƒë·ªÉ update l√™n Firebase lu√¥n
        updateData[`${path}.date`] = dateInput.value;

    } else {
        // TR∆Ø·ªúNG H·ª¢P B·ªé T√çCH:

        // 1. ·∫®n √¥ input
        dateInput.classList.add('hidden-date');

        // 2. Set ng√†y v·ªÅ null tr√™n Firebase
        updateData[`${path}.date`] = null;
    }
}

// --- G·ª≠i l√™n Firebase ---
try {
    // D√πng update ƒë·ªÉ ch·ªâ s·ª≠a ƒë√∫ng d√≤ng ƒë√≥, kh√¥ng ·∫£nh h∆∞·ªüng d·ªØ li·ªáu kh√°c
    await db.collection('maintenance').doc('schedules').update(updateData);
    console.log("ƒê√£ l∆∞u tr·∫°ng th√°i: " + path);
} catch (e) {
    // N·∫øu document ch∆∞a t·ªìn t·∫°i th√¨ d√πng set merge
    await db.collection('maintenance').doc('schedules').set(updateData, { merge: true });
}
}


    // H√ÄM CHUNG: C·∫≠p nh·∫≠t ng√†y
   async function updateMaintDate(path, newDate) {
// path: v·∫´n l√† ƒë∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß nh∆∞ tr√™n
const updateData = {};
updateData[`${path}.date`] = newDate;

try {
    await db.collection('maintenance').doc('schedules').update(updateData);
    console.log("ƒê√£ c·∫≠p nh·∫≠t ng√†y m·ªõi: " + newDate);
} catch (e) {
    await db.collection('maintenance').doc('schedules').set(updateData, { merge: true });
}
}

    // H√ÄM CHUNG: C·∫≠p nh·∫≠t ghi ch√∫
    async function updateMaintNote(path, note) {
        const update = {};
        update[path] = note;

        await db.collection('maintenance').doc('schedules').set(update, { merge: true });
    }

    function hardResetMaintenance() {
        if(confirm("X√ÅC NH·∫¨N: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu b·∫£o tr√¨ v√† kh√¥i ph·ª•c l·∫°i m·∫∑c ƒë·ªãnh?")) {
             db.collection('maintenance').doc('schedules').set({});
             document.getElementById('maintenanceError').style.display = 'none';
             alert("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu b·∫£o tr√¨.");
        }
    }
    function updateChecklistItemTime(day, ovenName, itemIndex, newTime) {
       const monthYear = `${viewMonth}_${viewYear}`;
       // Tham chi·∫øu ƒë·∫øn t√†i li·ªáu ch·ª©a to√†n b·ªô l·ªãch b·∫£o tr√¨
       const docRef = db.collection('maintenance').doc('schedules');

      // T·∫°o ƒë∆∞·ªùng d·∫´n (path) ƒë·ªông ƒë·∫øn tr∆∞·ªùng 'time' c·ª• th·ªÉ c·ªßa m·ª•c ki·ªÉm tra.
      // V√≠ d·ª•: 06_2025.D10.L√≤ 1.items.2.time
      const itemPath = `${monthYear}.${day}.${ovenName}.items.${itemIndex}.time`;

       // S·ª≠ d·ª•ng Firestore update ƒë·ªÉ c·∫≠p nh·∫≠t ch√≠nh x√°c tr∆∞·ªùng ƒë√≥
       docRef.update({
          [itemPath]: newTime
       }).then(() => {
          console.log(`ƒê√£ l∆∞u th·ªùi gian m·ªõi cho ${ovenName} ng√†y ${day}: ${newTime}`);

          // C·∫≠p nh·∫≠t local cache ngay l·∫≠p t·ª©c ƒë·ªÉ kh√¥ng c·∫ßn t·∫£i l·∫°i trang
          if (maintenanceDataCache[monthYear] && maintenanceDataCache[monthYear][day] && maintenanceDataCache[monthYear][day][ovenName]) {
              maintenanceDataCache[monthYear][day][ovenName].items[itemIndex].time = newTime;
          }
       }).catch(error => {
           console.error("L·ªói khi c·∫≠p nh·∫≠t th·ªùi gian m·ª•c ki·ªÉm tra:", error);
           alert("L·ªói: Kh√¥ng th·ªÉ l∆∞u th·ªùi gian m·ªõi l√™n server!");
       });
   }


    // 8. H·ªÜ TH·ªêNG PH√ÇN T√çCH S·∫¢N L∆Ø·ª¢NG (Excel Reader, Data Processor)

    // ƒê·ªçc d·ªØ li·ªáu t·ª´ file Excel
    function readExcelFile(file, headerRowIndex) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // S·ª≠ d·ª•ng raw: false v√† cellDates: true ƒë·ªÉ l·∫•y ƒë·ªãnh d·∫°ng ng√†y th√°ng t·ªët nh·∫•t
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, raw: false });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // 1. ƒê·ªåC D√íNG TI√äU ƒê·ªÄ
                    const rawRows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, cellDates: true });
                    const headerRowData = rawRows[headerRowIndex - 1];
                    if (!headerRowData || headerRowData.length === 0) {
                        reject(new Error(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ·ªü D√≤ng Ti√™u ƒê·ªÅ (${headerRowIndex}) trong file: ${file.name}`));
                        return;
                    }

                    // T√ÅI T·∫†O MAP K√ù T·ª∞ C·ªòT -> T√äN HEADER TH·ª∞C T·∫æ
                    let currentColMap = {};
                    headerRowData.forEach((headerName, C) => {
                        if (headerName) {
                            const colLetter = XLSX.utils.encode_col(C);
                            // L∆∞u v√†o map: { "A": "Lot_ID", "B": "Process" ...}
                            currentColMap[colLetter.toUpperCase()] = headerName.toString().trim();
                        }
                    });

                    // 2. ƒê·ªåC D·ªÆ LI·ªÜU CH√çNH (B·ªè qua c√°c d√≤ng tr∆∞·ªõc d√≤ng header)
                    const fileData = XLSX.utils.sheet_to_json(worksheet, { range: headerRowIndex - 1, raw: false, cellDates: true });

                    resolve({ fileData, currentColMap });

                } catch (error) {
                    reject(new Error(`L·ªói ƒë·ªçc file ${file.name}: ${error.message}`));
                }
            };
            reader.onerror = (error) => reject(new Error(`L·ªói ƒë·ªçc file ${file.name}: ${error.message}`));
            reader.readAsArrayBuffer(file);
        });
    }

    // H√†m x·ª≠ l√Ω khi ch·ªçn file (ƒê·∫ßu V√ÄO ho·∫∑c ƒê·∫ßu RA)
    async function handleFileSelection(event, type) {
        document.getElementById('excelError').innerText = '';
        document.getElementById('productionStatsContainer').style.display = 'none';
        document.getElementById('exportBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'none';

        const headerRowIndex = parseInt(document.getElementById('headerRowInput').value) || 1;
        const files = Array.from(event.target.files);
        let allData = [];
        let currentColMap = null;
        const fileListEl = document.getElementById(`fileList_${type}`);

        fileListEl.innerHTML = files.map(f => `<span>${f.name}</span>`).join(', ');
        fileListEl.style.color = files.length > 0 ? 'green' : 'red';
        if (files.length === 0) fileListEl.innerHTML = 'Ch∆∞a ch·ªçn file.';

        if (type === 'IN') inputFiles = files;
        else outputFiles = files;

        if (files.length === 0) {
            if (type === 'IN') allInputData = [];
            else allOutputData = [];
            updatePersonSelectBox();
            return;
        }

        try {
            // ƒê·ªçc file l·∫ßn l∆∞·ª£t
            const results = await Promise.all(files.map(file => readExcelFile(file, headerRowIndex)));

            results.forEach((res, index) => {
                allData = allData.concat(res.fileData);
                // L·∫•y map c·ªôt t·ª´ file ƒë·∫ßu ti√™n (gi·∫£ ƒë·ªãnh c√°c file c√≥ c·∫•u tr√∫c gi·ªëng nhau)
                if (index === 0) {
                    currentColMap = res.currentColMap;
                }
            });

        } catch (error) {
            document.getElementById('excelError').innerText = error.message;
            // N·∫øu l·ªói, x√≥a h·∫øt d·ªØ li·ªáu ƒë√£ ƒë·ªçc
            if (type === 'IN') { allInputData = []; inputFiles = []; }
            else { allOutputData = []; outputFiles = []; }
            fileListEl.innerHTML = '<span style="color:red;">L·ªói t·∫£i file.</span>';
            updatePersonSelectBox();
            return;
        }

        if (files.length > 0) {
            document.getElementById('excelError').innerText = `‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng ${files.length} file cho ƒê·∫ßu ${type==='IN'?'V√ÄO':'RA'}. T·ªïng ${allData.length} d√≤ng d·ªØ li·ªáu.`;
        }

        // L∆∞u tr·ªØ d·ªØ li·ªáu v√† map t∆∞∆°ng ·ª©ng
        if (type === 'IN') {
            allInputData = allData;
            if (currentColMap) inputColMap = currentColMap; // L∆ØU MAP CHO ƒê·∫¶U V√ÄO
        } else {
            allOutputData = allData;
            if (currentColMap) outputColMap = currentColMap; // L∆ØU MAP CHO ƒê·∫¶U RA
        }

        // C·∫≠p nh·∫≠t th√¥ng b√°o c·∫•u h√¨nh c·ªôt
        if (files.length > 0 && currentColMap) {
            document.getElementById('excelError').innerText += `\n\nüí° **T√™n c·ªôt chu·∫©n cho ƒê·∫ßu ${type==='IN'?'V√ÄO':'RA'} ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p.**`;
        }

        // C·∫≠p nh·∫≠t danh s√°ch Ng∆∞·ªùi TH
        updatePersonSelectBox();
    }

    // C·∫≠p nh·∫≠t danh s√°ch ng∆∞·ªùi l√†m vi·ªác t·ª´ d·ªØ li·ªáu ƒë√£ t·∫£i
    function updatePersonSelectBox() {
        const personSet = new Set();
        const personColLetter = document.getElementById('colPersonInput').value.trim().toUpperCase();

        const getPersonName = (data, map) => {
            if (!map || Object.keys(map).length === 0) return null;
            const personColName = map[personColLetter];
            if (!personColName) return null;

            data.forEach(row => {
                const name = row[personColName];
                if (name && typeof name === 'string' && name.trim()) {
                    personSet.add(name.trim());
                }
            });
        };

        getPersonName(allInputData, inputColMap);
        getPersonName(allOutputData, outputColMap);

        const personSelect = document.getElementById('personSelect');
        const currentSelected = personSelect.value;
        personSelect.innerHTML = '<option value="all">-- T·∫•t C·∫£ M·ªçi Ng∆∞·ªùi --</option>';

        const sortedPeople = Array.from(personSet).sort();

        sortedPeople.forEach(person => {
            const option = document.createElement('option');
            option.value = person;
            option.textContent = person;
            personSelect.appendChild(option);
        });

        // Gi·ªØ l·∫°i l·ª±a ch·ªçn hi·ªán t·∫°i n·∫øu c√≤n trong danh s√°ch
        if (personSet.has(currentSelected)) {
            personSelect.value = currentSelected;
        }
    }

    // X·ª≠ l√Ω d·ªØ li·ªáu th√¥ (Raw Data) ƒë·ªÉ t·∫°o th·ªëng k√™ (Stats)
    function processData(data, colNames, selectedPerson, selectedMonth, selectedYear) {
        let stats = {};
        let grandTotal = 0;

        if (!colNames.prodColName || !colNames.personColName || !colNames.processColName || !colNames.dateColName) {
            console.error("Thi·∫øu t√™n c·ªôt!");
            return { stats: {}, grandTotal: 0 };
        }

        data.forEach(row => {
            // L·∫•y gi√° tr·ªã
            const person = row[colNames.personColName]?.toString().trim();
            const process = row[colNames.processColName]?.toString().trim();
            const dateRaw = row[colNames.dateColName];
            const panels = parseFloat(row[colNames.prodColName]);

            // X·ª≠ l√Ω ng√†y th√°ng
            let rowDate = null;
            if (dateRaw) {
                // Excel dates are sometimes stored as numbers if not formatted correctly
                if (typeof dateRaw === 'number') {
                    // Excel Epoch is 1899-12-30
                    rowDate = new Date(Date.UTC(0, 0, dateRaw - 1));
                } else if (dateRaw instanceof Date && !isNaN(dateRaw)) {
                    rowDate = dateRaw;
                } else if (typeof dateRaw === 'string') {
                     rowDate = new Date(dateRaw);
                }
            }

            // Ki·ªÉm tra ƒëi·ªÅu ki·ªán l·ªçc
            const isValid = person && process && !isNaN(panels) && panels > 0 && rowDate && !isNaN(rowDate.getTime());
            if (!isValid) return;

            const rowMonth = String(rowDate.getMonth() + 1).padStart(2, '0');
            const rowYear = rowDate.getFullYear().toString();

            const monthMatch = rowMonth === selectedMonth;
            const yearMatch = rowYear === selectedYear;
            const personMatch = selectedPerson === 'all' || person === selectedPerson;

            if (monthMatch && yearMatch && personMatch) {
                // Th√™m v√†o danh s√°ch c√¥ng ƒëo·∫°n chung
                processList.add(process);

                // C·∫≠p nh·∫≠t th·ªëng k√™
                if (!stats[person]) {
                    stats[person] = { grandTotal: 0 };
                }

                stats[person][process] = (stats[person][process] || 0) + panels;
                stats[person].grandTotal += panels;
                grandTotal += panels;
            }
        });

        return { stats, grandTotal };
    }

    // K·∫øt h·ª£p th·ªëng k√™ t·ª´ file IN v√† OUT
    function combineStats(statsIn, statsOut) {
        let combinedStats = {};
        let grandTotal = 0;
        const allPeople = new Set([...Object.keys(statsIn), ...Object.keys(statsOut)]);

        allPeople.forEach(personName => {
            let pStats = { grandTotal: 0 };
            const dataIn = statsIn[personName] || {};
            const dataOut = statsOut[personName] || {};

            // Duy·ªát qua t·∫•t c·∫£ c√°c c√¥ng ƒëo·∫°n ƒë√£ t√¨m th·∫•y
            processList.forEach(proc => {
                const valIn = dataIn[proc] || 0;
                const valOut = dataOut[proc] || 0;
                const total = valIn + valOut;

                pStats[proc] = total;
                pStats.grandTotal += total;
            });

            combinedStats[personName] = pStats;
            grandTotal += pStats.grandTotal;
        });

        return { stats: combinedStats, grandTotal };
    }

    // H√†m l·∫•y class m√†u cho √¥ c√¥ng ƒëo·∫°n
    function getColorClass(processName) {
        if (!processName) return 'color-default'; // N·∫æU R·ªñNG TH√å D√ôNG M·∫∂C ƒê·ªäNH
        const key = processName.toUpperCase().replace(/[^A-Z0-9]/g, ''); // X√≥a k√Ω t·ª± ƒë·∫∑c bi·ªát
        // Tr·∫£ v·ªÅ m√†u ƒë·ªãnh s·∫µn ho·∫∑c m√†u m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng kh·ªõp
        return PROCESS_COLORS[key] || 'color-default';
    }

    // H√ÄM M·ªöI: T√çNH T·∫§M/GI·ªú V√Ä C·∫¨P NH·∫¨T GIAO DI·ªÜN
    function calculatePanelsPerHour(personId, totalPanels) {
        // S·ª≠ d·ª•ng ID c·ªßa ng∆∞·ªùi ƒë·ªÉ l·∫•y gi√° tr·ªã nh·∫≠p li·ªáu
        const workingDays = parseFloat(document.getElementById(`days_${personId}`).value) || 0;
        const otHours = parseFloat(document.getElementById(`ot_${personId}`).value) || 0;
        const resultEl = document.getElementById(`pph_${personId}`);

        // 1 ng√†y l√†m vi·ªác l√† 8 gi·ªù
        const totalHours = (workingDays * 8) + otHours;
        let panelsPerHour = 0;
        if (totalHours > 0) {
            panelsPerHour = totalPanels / totalHours;
        }

        // C·∫≠p nh·∫≠t k·∫øt qu·∫£ tr√™n giao di·ªán
        resultEl.textContent = panelsPerHour.toLocaleString('vi-VN', { maximumFractionDigits: 2 });
    }

    // H√†m render c√°c b·∫£ng th·ªëng k√™ (ƒê√É C·∫¨P NH·∫¨T ƒê·ªÇ HI·ªÇN TH·ªä T·∫§M/GI·ªú THEO NG∆Ø·ªúI V√Ä ·∫®N C·ªòT T√çNH TO√ÅN)
function renderStatsTables(statsData, month, year) {
const container = document.getElementById('productionStatsContainer');
container.style.display = 'flex';
container.innerHTML = '';

// L·∫•y danh s√°ch c√¥ng ƒëo·∫°n chung t·ª´ c·∫£ IN v√† OUT
// L∆∞u √Ω: processList l√† bi·∫øn to√†n c·ª•c ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong calculateProduction
const allProcesses = Array.from(processList).sort();
const peopleForInitialCalc = []; // Danh s√°ch ng∆∞·ªùi ƒë·ªÉ t√≠nh T·∫•m/gi·ªù ban ƒë·∫ßu

// Duy·ªát qua 3 lo·∫°i b√°o c√°o ['input', 'output', 'total'].
['input', 'output', 'total'].forEach(key => {
    const { title, data, total, files } = statsData[key];
    const sortedPeople = Object.keys(data).map(name => ({ name: name, data: data[name], total: data[name].grandTotal })).filter(p => p.total > 0).sort((a, b) => b.total - a.total);

    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã, b·ªè qua b·∫£ng n√†y
    if (sortedPeople.length === 0) return;

    // T·∫°o khung ch·ª©a b·∫£ng
    let section = `<div id="statsBox_${key}" style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
        <h3>${title} <span style="font-size: 14px; font-weight: normal; color: #666;">(${files})</span></h3>
        <table class="stats-table" id="table_${key}">
            <thead>
                <tr>
                    <th class="person-col" rowspan="2">Ng∆∞·ªùi TH</th>
                    <th colspan="${allProcesses.length}">C√îNG ƒêO·∫†N (T·∫•m)</th>
                    <th rowspan="2">T·ªîNG</th>

                    ${key === 'total' ? `
                        <th colspan="2" style="background: #f0f8ff; color: #007bff;">ƒê·∫¶U V√ÄO T√çNH TO√ÅN</th>
                        <th rowspan="2" style="background: var(--success); color: white;">T·∫§M/GI·ªú</th>
                    ` : ''}
                </tr>
                <tr>
                    ${allProcesses.map(p => `<th>${p}</th>`).join('')}

                    ${key === 'total' ? `
                        <th style="background: #f0f8ff; color: #007bff;">S·ªë ng√†y l√†m</th>
                        <th style="background: #f0f8ff; color: #007bff;">Gi·ªù TC</th>
                    ` : ''}
                </tr>
            </thead>
            <tbody>`;

    // Th√™m d·ªØ li·ªáu cho t·ª´ng ng∆∞·ªùi
    sortedPeople.forEach(person => {
        const personId = person.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); // T·∫°o ID an to√†n
        const totalPanels = person.total;

        // Ch·ªâ th√™m v√†o danh s√°ch c·∫ßn t√≠nh T·∫•m/gi·ªù n·∫øu l√† b·∫£ng T·ªîNG H·ª¢P
        if (key === 'total') {
            peopleForInitialCalc.push({ id: personId, total: totalPanels });
        }

        section += `<tr id="person_${personId}">
            <td class="person-col">${person.name}</td>`;

        // C·ªôt C√¥ng ƒêo·∫°n (T√¥ m√†u ƒë∆∞·ª£c √°p d·ª•ng ·ªü ƒë√¢y)
        allProcesses.forEach(proc => {
            const value = person.data[proc] || 0;
            const colorClass = getColorClass(proc); // Th√™m m√†u n·ªÅn cho √¥ d·ªØ li·ªáu c√¥ng ƒëo·∫°n
            section += `<td class="process-cell ${colorClass}">${value > 0 ? value.toLocaleString('vi-VN') : '-'}</td>`;
        });

        // C·ªôt T·ªîNG
        section += `<td class="total-col">${totalPanels.toLocaleString('vi-VN')}</td>`;

        // C·ªôt Ng√†y l√†m vi·ªác, Gi·ªù OT, T·∫•m/gi·ªù (Ch·ªâ hi·ªÉn th·ªã cho b·∫£ng T·ªîNG H·ª¢P)
        if (key === 'total') {
            section += `
                <td><input type="number" id="days_${personId}" value="20" min="0" oninput="calculatePanelsPerHour('${personId}', ${totalPanels})" style="width: 90%; text-align: right; padding: 4px;"></td>
                <td><input type="number" id="ot_${personId}" value="0" min="0" oninput="calculatePanelsPerHour('${personId}', ${totalPanels})" style="width: 90%; text-align: right; padding: 4px;"></td>
                <td id="pph_${personId}" class="total-col" style="background: #e9f7ef; color: #155724;"> 0.00 </td>`;
        }
        // KH√îNG C·∫¶N ELSE N·ªÆA V√å C√ÅC C·ªòT ƒê√ì ƒê√É KH√îNG ƒê∆Ø·ª¢C RENDER TRONG HEADER

        section += `</tr>`;
    });

    // H√†ng T·ªïng C·ªông (Grand Total)
    // Colspan ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh t√πy theo key (4 c·ªôt ·∫©n/hi·ªán)
    const totalColspan = key === 'total' ? allProcesses.length + 1 : allProcesses.length;

    section += `<tr class="grand-total-row">
        <th colspan="${totalColspan}">T·ªîNG C·ªòNG</th>
        <td colspan="1">${total.toLocaleString('vi-VN')}</td>
        ${key === 'total' ? `<td colspan="3" style="text-align: center; background: #f0f0f0;">(T√≠nh theo ng∆∞·ªùi)</td>` : ''}
        </tr>`;

    section += `</tbody></table></div>`;
    container.insertAdjacentHTML('beforeend', section);
});

// Sau khi render xong, t√≠nh to√°n T·∫•m/gi·ªù ban ƒë·∫ßu
if (peopleForInitialCalc.length > 0) {
    // D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render xong input
    setTimeout(() => {
        peopleForInitialCalc.forEach(person => {
            // Ki·ªÉm tra l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o element days_personId ƒë√£ c√≥
            if(document.getElementById(`days_${person.id}`)) {
                calculatePanelsPerHour(person.id, person.total);
            }
        });
    }, 100);
}

document.getElementById('exportBtn').style.display = 'inline-block';
document.getElementById('captureBtn').style.display = 'inline-block';
}

    // H√†m ch√≠nh t√≠nh to√°n s·∫£n l∆∞·ª£ng
    function calculateProduction() {
        document.getElementById('productionStatsContainer').style.display = 'none';
        document.getElementById('productionStatsContainer').innerHTML = '';
        document.getElementById('exportBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'none';
        document.getElementById('excelError').innerText = '';

        if (allInputData.length === 0 && allOutputData.length === 0) {
            document.getElementById('excelError').innerText = 'Vui l√≤ng t·∫£i √≠t nh·∫•t m·ªôt file (ƒê·∫ßu V√ÄO ho·∫∑c ƒê·∫ßu RA).';
            return;
        }

        // **KI·ªÇM TRA MAP**: Ch·ªâ c·∫ßn map t·ªìn t·∫°i n·∫øu c√≥ d·ªØ li·ªáu cho lo·∫°i ƒë√≥
        if (allInputData.length > 0 && Object.keys(inputColMap).length === 0) {
            document.getElementById('excelError').innerText = 'L·ªói: Vui l√≤ng t·∫£i l·∫°i file ƒê·∫¶U V√ÄO ƒë·∫ßu ti√™n ƒë·ªÉ x√°c ƒë·ªãnh T√™n Header.';
            return;
        }
        if (allOutputData.length > 0 && Object.keys(outputColMap).length === 0) {
            document.getElementById('excelError').innerText = 'L·ªói: Vui l√≤ng t·∫£i l·∫°i file ƒê·∫¶U RA ƒë·∫ßu ti√™n ƒë·ªÉ x√°c ƒë·ªãnh T√™n Header.';
            return;
        }

        const prodColLetter = document.getElementById('colProdInput').value.trim().toUpperCase();
        const personColLetter = document.getElementById('colPersonInput').value.trim().toUpperCase();
        const processColLetter = document.getElementById('colProcessInput').value.trim().toUpperCase();
        const dateColLetter = document.getElementById('colDateInput').value.trim().toUpperCase();

        // *** T·∫†O HAI B·ªò T√äN C·ªòT RI√äNG BI·ªÜT ***
        const getColNames = (map) => {
            // Ch·ªâ tr·∫£ v·ªÅ t√™n c·ªôt n·∫øu c√≥ d·ªØ li·ªáu v√† map c√≥ gi√° tr·ªã
            if (Object.keys(map).length === 0) return {};
            return {
                prodColName: map[prodColLetter],
                personColName: map[personColLetter],
                processColName: map[processColLetter],
                dateColName: map[dateColLetter],
            };
        };

        const inputColNames = getColNames(inputColMap);
        const outputColNames = getColNames(outputColMap);

        // Ki·ªÉm tra xem t·∫•t c·∫£ c√°c c·ªôt c·∫ßn thi·∫øt c√≥ ƒë∆∞·ª£c map th√†nh c√¥ng kh√¥ng
        const checkMissingCols = (colNames) => {
            const missing = [];
            if (!colNames.prodColName) missing.push(`C·ªôt S·∫£n L∆∞·ª£ng (${prodColLetter})`);
            if (!colNames.personColName) missing.push(`C·ªôt Ng∆∞·ªùi TH (${personColLetter})`);
            if (!colNames.processColName) missing.push(`C·ªôt C√¥ng ƒêo·∫°n (${processColLetter})`);
            if (!colNames.dateColName) missing.push(`C·ªôt Ng√†y Th√°ng (${dateColLetter})`);
            return missing;
        };

        const missingIn = allInputData.length > 0 ? checkMissingCols(inputColNames) : [];
        const missingOut = allOutputData.length > 0 ? checkMissingCols(outputColNames) : [];

        if (missingIn.length > 0 || missingOut.length > 0) {
            let errorMsg = '‚ö†Ô∏è L·ªói c·∫•u h√¨nh c·ªôt! Kh√¥ng t√¨m th·∫•y ti√™u ƒë·ªÅ c·ªôt t∆∞∆°ng ·ª©ng. Vui l√≤ng ki·ªÉm tra l·∫°i K√Ω T·ª± C·ªôt v√† D√≤ng Ti√™u ƒê·ªÅ ƒë√£ nh·∫≠p.\n';
            if (missingIn.length > 0) errorMsg += ` - **File ƒê·∫ßu V√ÄO**: ${missingIn.join(', ')}\n`;
            if (missingOut.length > 0) errorMsg += ` - **File ƒê·∫ßu RA**: ${missingOut.join(', ')}\n`;
            document.getElementById('excelError').innerHTML = errorMsg.replace(/\n/g, '<br>');
            return;
        }

        // Reset global process list
        processList = new Set();
        const selectedPerson = document.getElementById('personSelect').value;
        const selectedMonth = document.getElementById('prodMonth').value;
        const selectedYear = document.getElementById('prodYear').value;

        // 1. T√çNH TO√ÅN ƒê·∫¶U V√ÄO (D√πng inputColNames)
        const inputResults = allInputData.length > 0 ? processData(allInputData, inputColNames, selectedPerson, selectedMonth, selectedYear) : { stats: {}, grandTotal: 0 };

        // 2. T√çNH TO√ÅN ƒê·∫¶U RA (D√πng outputColNames)
        const outputResults = allOutputData.length > 0 ? processData(allOutputData, outputColNames, selectedPerson, selectedMonth, selectedYear) : { stats: {}, grandTotal: 0 };

        // 3. T√çNH TO√ÅN T·ªîNG (IN + OUT)
        const combinedResults = combineStats(inputResults.stats, outputResults.stats);
        const grandTotalPanels = combinedResults.grandTotal;

        // 4. KI·ªÇM TRA L·ªñI CU·ªêI C√ôNG
        if (combinedResults.grandTotal === 0) {
            // C·∫≠p nh·∫≠t th√¥ng b√°o l·ªói ƒë·ªÉ ph·∫£n √°nh logic m·ªõi
            const sampleColName = inputColNames.prodColName || outputColNames.prodColName || 'Ch∆∞a r√µ';
            const sampleDateName = inputColNames.dateColName || outputColNames.dateColName || 'Ch∆∞a r√µ';

            let errorMsg = `‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá n√†o cho ƒëi·ªÅu ki·ªán ƒë√£ ch·ªçn (Th√°ng ${selectedMonth}/${selectedYear}`;
            if (selectedPerson !== 'all') errorMsg += ` v√† Ng∆∞·ªùi TH: ${selectedPerson}`;
            errorMsg += `).\n\nVui l√≤ng ki·ªÉm tra:\n`;
            errorMsg += `- **Ng√†y th√°ng** trong file c√≥ kh·ªõp v·ªõi ƒë·ªãnh d·∫°ng '${sampleDateName}' v√† kho·∫£ng th·ªùi gian T${selectedMonth}/${selectedYear} kh√¥ng.\n`;
            errorMsg += `- **C·ªôt S·∫£n L∆∞·ª£ng** ('${sampleColName}') c√≥ ch·ª©a gi√° tr·ªã s·ªë (T·∫•m) > 0 kh√¥ng.`;

            document.getElementById('excelError').innerHTML = errorMsg.replace(/\n/g, '<br>');
            return;
        }

        // 5. CHU·∫®N B·ªä D·ªÆ LI·ªÜU ƒê·ªÇ RENDER
        const statsData = {
            input: {
                title: 'B√ÅO C√ÅO S·∫¢N L∆Ø·ª¢NG ƒê·∫¶U V√ÄO',
                data: inputResults.stats,
                total: inputResults.grandTotal,
                files: inputFiles.map(f => f.name).join(', ') || 'Kh√¥ng c√≥ file',
            },
            output: {
                title: 'B√ÅO C√ÅO S·∫¢N L∆Ø·ª¢NG ƒê·∫¶U RA',
                data: outputResults.stats,
                total: outputResults.grandTotal,
                files: outputFiles.map(f => f.name).join(', ') || 'Kh√¥ng c√≥ file',
            },
            total: {
                title: `B√ÅO C√ÅO T·ªîNG H·ª¢P S·∫¢N L∆Ø·ª¢NG T${selectedMonth}/${selectedYear}`,
                data: combinedResults.stats,
                total: combinedResults.grandTotal,
                files: 'T·ªïng h·ª£p t·ª´ File IN v√† OUT',
            }
        };

        // 6. RENDER
        renderStatsTables(statsData, selectedMonth, selectedYear);
    }

    /**
* Xu·∫•t d·ªØ li·ªáu s·∫£n l∆∞·ª£ng t·ª´ c√°c b·∫£ng DAU_VAO, DAU_RA v√† TONG_HOP ra file Excel.
* H√†m n√†y bao g·ªìm logic x·ª≠ l√Ω c√°c tr∆∞·ªùng <input> trong b·∫£ng T·ªîNG H·ª¢P ƒë·ªÉ l·∫•y gi√° tr·ªã hi·ªán t·∫°i thay v√¨ th·∫ª input.
*/
function exportToExcel() {
const month = document.getElementById('prodMonth').value;
const year = document.getElementById('prodYear').value;
const filename = `BAO_CAO_SAN_LUONG_${month}_${year}_${new Date().getTime()}.xlsx`;
const wb = XLSX.utils.book_new();

// L·∫•y danh s√°ch c√¥ng ƒëo·∫°n chung (Gi·∫£ s·ª≠ processList l√† bi·∫øn to√†n c·ª•c ƒë√£ ƒë∆∞·ª£c khai b√°o)
const allProcesses = Array.from(processList).sort();

// H√†m tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ b·∫£ng HTML
function getTableData(tableId, sheetName) {
    const table = document.getElementById(tableId);
    if (!table) return null;

    // Ti√™u ƒë·ªÅ
    const titleText = document.querySelector(`#statsBox_${tableId.split('_')[1]} h3`).textContent;
    const title = [[titleText]];
    const ws_title = XLSX.utils.aoa_to_sheet(title);

    // L·∫•y HTML c·ªßa b·∫£ng g·ªëc
    const tableHtml = table.outerHTML;
    let tempTableHtml = tableHtml;

    // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi input th√†nh gi√° tr·ªã cho b·∫£ng T·ªîNG H·ª¢P
    if (sheetName === 'TONG_HOP') {
        // D√πng DOMParser ƒë·ªÉ x·ª≠ l√Ω HTML m√† kh√¥ng c·∫ßn render ra giao di·ªán
        const parser = new DOMParser();
        const doc = parser.parseFromString(tableHtml, 'text/html');
        const tempTable = doc.querySelector(`#${tableId}`);

        if(tempTable) {
            tempTable.querySelectorAll('tbody tr').forEach(row => {
                // B·ªè qua d√≤ng Grand Total
                if (row.classList.contains('grand-total-row')) return;

                const personId = row.id.replace('person_', '');

                // L·∫•y gi√° tr·ªã c·ªßa input (t·ª´ DOM th·∫≠t ƒëang hi·ªÉn th·ªã)
                const daysInput = document.getElementById(`days_${personId}`);
                const otInput = document.getElementById(`ot_${personId}`);
                const pphCell = document.getElementById(`pph_${personId}`);

                // Thay th·∫ø input/cell trong HTML t·∫°m th·ªùi b·∫±ng gi√° tr·ªã c·ªßa n√≥
                const tempRow = tempTable.querySelector(`#${row.id}`);

                // C·ªôt Ng√†y l√†m vi·ªác
                if (daysInput && tempRow.children[allProcesses.length + 2]) {
                    tempRow.children[allProcesses.length + 2].innerHTML = daysInput.value;
                }
                // C·ªôt Gi·ªù tƒÉng ca
                if (otInput && tempRow.children[allProcesses.length + 3]) {
                    tempRow.children[allProcesses.length + 3].innerHTML = otInput.value;
                }
                // C·ªôt T·∫•m/Gi·ªù
                 if (pphCell && tempRow.children[allProcesses.length + 4]) {
                    tempRow.children[allProcesses.length + 4].innerHTML = pphCell.textContent.trim();
                }
            });
            tempTableHtml = tempTable.outerHTML;
        }
    }

    // === KH·∫ÆC PH·ª§C L·ªñI T·∫†I ƒê√ÇY ===
    // 1. T·∫°o ph·∫ßn t·ª≠ DIV t·∫°m th·ªùi
    const tempDiv = document.createElement('div');
    // 2. G√°n chu·ªói HTML ƒë√£ chu·∫©n b·ªã v√†o innerHTML
    tempDiv.innerHTML = tempTableHtml;
    // 3. Truy·ªÅn ph·∫ßn t·ª≠ DOM (tempDiv) v√†o h√†m table_to_sheet
    const ws_table = XLSX.utils.table_to_sheet(tempDiv);
    // =============================

    const range = XLSX.utils.decode_range(ws_table['!ref']);

    // Di chuy·ªÉn d·ªØ li·ªáu b·∫£ng xu·ªëng 1 d√≤ng ƒë·ªÉ ch·ª´a ch·ªó cho ti√™u ƒë·ªÅ
    for (let R = range.e.r; R >= range.s.r; R--) {
        for (let C = range.e.c; C >= range.s.c; C--) {
            const cellref = XLSX.utils.encode_cell({ r: R, c: C });
            const targetref = XLSX.utils.encode_cell({ r: R + 1, c: C });
            ws_title[targetref] = ws_table[cellref];
        }
    }

    // C·∫≠p nh·∫≠t l·∫°i d·∫£i √¥ c·ªßa sheet m·ªõi
    if (ws_table['!ref']) {
        const newRange = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: range.e.r + 1, c: range.e.c } });
        ws_title['!ref'] = newRange;
    }

    // ƒê·ªãnh d·∫°ng c·ªôt
    const wscols = [];
    wscols.push({ wch: 20 }); // C·ªôt T√™n ng∆∞·ªùi
    for(let i=0; i < allProcesses.length; i++) {
        wscols.push({ wch: 15 }); // C·ªôt c√¥ng ƒëo·∫°n
    }
    wscols.push({ wch: 15 }); // C·ªôt T·ªïng

    if (sheetName === 'TONG_HOP') {
        wscols.push({ wch: 15 }); // C·ªôt Ng√†y l√†m vi·ªác
        wscols.push({ wch: 15 }); // C·ªôt Gi·ªù tƒÉng ca
        wscols.push({ wch: 15 }); // C·ªôt T·∫•m/Gi·ªù
    }

    ws_title['!cols'] = wscols;

    return ws_title;
}

// Th√™m t·ª´ng b·∫£ng v√†o workbook
const sheetNames = [
    { id: 'table_input', name: 'DAU_VAO_IN' },
    { id: 'table_output', name: 'DAU_RA_OUT' },
    { id: 'table_total', name: 'TONG_HOP' }
];

sheetNames.forEach(sheet => {
    const ws = getTableData(sheet.id, sheet.name);
    if (ws) {
        XLSX.utils.book_append_sheet(wb, ws, sheet.name);
    }
});

// Ghi file
XLSX.writeFile(wb, filename);
// Gi·∫£ s·ª≠ h√†m sendDiscordNotification t·ªìn t·∫°i v√† ho·∫°t ƒë·ªông
sendDiscordNotification(`üìä **ƒê√£ xu·∫•t file b√°o c√°o S·∫£n L∆∞·ª£ng T${month}/${year}**.`);
}

    // 10. CH·ª®C NƒÇNG CH·ª§P ·∫¢NH B·∫¢NG TH·ªêNG K√ä (ƒê√£ ch·ªânh s·ª≠a ƒë·ªÉ ·∫©n input khi ch·ª•p)
    function captureAndDownloadStats() {
        const container = document.getElementById('productionStatsContainer');
        if (!container || container.style.display === 'none') {
            alert("Vui l√≤ng T√≠nh T·ªïng S·∫£n L∆∞·ª£ng tr∆∞·ªõc khi ch·ª•p ·∫£nh.");
            return;
        }

        const month = document.getElementById('prodMonth').value;
        const year = document.getElementById('prodYear').value;
        const title = `BAO CAO SAN LUONG THANG ${month}/${year}`;

        // T·∫°m th·ªùi ·∫©n c√°c input ƒë·ªÉ ch·ª•p ·∫£nh ƒë·∫πp h∆°n
        const inputs = container.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.style.display = 'none';
            // Th√™m gi√° tr·ªã text b√™n c·∫°nh
            input.parentNode.insertAdjacentText('beforeend', input.value);
        });

        html2canvas(container, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.href = imageURL;
            link.download = `${title.replace(/ /g, '_')}_${new Date().getTime()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Kh√¥i ph·ª•c l·∫°i input
            inputs.forEach(input => {
                input.style.display = 'inline-block';
                // X√≥a node text v·ª´a th√™m v√†o (nodeValue === input.value)
                if (input.nextSibling && input.nextSibling.nodeType === 3 && input.nextSibling.nodeValue === input.value) {
                     input.parentNode.removeChild(input.nextSibling);
                }
            });

            alert("ƒê√£ ch·ª•p ·∫£nh v√† l∆∞u v√†o m√°y!");
        }).catch(err => {
            console.error("L·ªói ch·ª•p ·∫£nh:", err);
            alert("L·ªói: Kh√¥ng th·ªÉ ch·ª•p ·∫£nh th·ªëng k√™.");
            // ƒê·∫£m b·∫£o kh√¥i ph·ª•c input n·∫øu c√≥ l·ªói
            inputs.forEach(input => {
                input.style.display = 'inline-block';
                if (input.nextSibling && input.nextSibling.nodeType === 3 && input.nextSibling.nodeValue === input.value) {
                     input.parentNode.removeChild(input.nextSibling);
                }
            });
        });
    }

    // 11. KH·∫ÆC PH·ª§C L·ªñI REFERENCE ERROR: G·∫ÆN EVENT LISTENER SAU KHI T·∫¢I XONG
    document.addEventListener('DOMContentLoaded', () => {
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        if (loginBtn) {
            // ƒê√≠nh k√®m h√†m handleLogin v√†o s·ª± ki·ªán click
            loginBtn.addEventListener('click', handleLogin);
        }
        if (logoutBtn) {
             // ƒê√≠nh k√®m h√†m handleLogout v√†o s·ª± ki·ªán click
             logoutBtn.addEventListener('click', handleLogout);
        }
    });


</script>
</body>
</html>