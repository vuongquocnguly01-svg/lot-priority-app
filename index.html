<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch Lot h√†ng c·∫ßn ∆∞u ti√™n nung - Firebase</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- C·∫§U H√åNH G·ªêC --- */
        :root {
            --primary-color: #007bff; /* M√†u xanh d∆∞∆°ng ch√≠nh */
            --success-color: #28a745; /* M√†u xanh l√° cho n√∫t Th√™m */
            --danger-color: #dc3545; /* M√†u ƒë·ªè cho n√∫t X√≥a/ƒêƒÉng xu·∫•t */
            --text-color: #333;
            --bg-color: #f8f9fa; /* M√†u n·ªÅn nh·∫°t */
            --border-color: #dee2e6;
            --hover-bg: #e9ecef;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Cho n·ªôi dung ch√≠nh b·∫Øt ƒë·∫ßu t·ª´ tr√™n */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- CSS ƒêƒÇNG NH·∫¨P --- */
        #login-container {
            position: absolute; /* ƒê·∫£m b·∫£o n√≥ ·ªü gi·ªØa m√†n h√¨nh */
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            padding: 30px;
            background-color: white;
            box-shadow: var(--shadow-light);
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }
        #login-container h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
        }
        #login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        #login-container input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 16px;
            transition: background-color 0.2s, transform 0.1s;
        }
        #login-container button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        #error-message {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* --- CSS N·ªòI DUNG CH√çNH --- */
        #main-content {
            display: none;
            width: 95%;
            max-width: 1400px;
            margin-top: 0;
            padding: 30px;
            background-color: white;
            box-shadow: var(--shadow-light);
            border-radius: 10px;
            box-sizing: border-box;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 28px;
            color: var(--primary-color);
            margin: 0;
        }

        #logout-button {
            padding: 8px 15px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #logout-button:hover {
            background-color: #c82333;
        }

        /* --- Thanh t√¨m ki·∫øm v√† n√∫t Th√™m Lot --- */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-container input {
            padding: 10px 15px;
            width: 350px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        .search-container input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .add-button {
            padding: 10px 20px;
            background-color: var(--success-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .add-button:hover {
            background-color: #1e7e34;
        }

        /* --- Form Th√™m Lot --- */
        .add-form {
            display: none;
            margin: 20px auto;
            width: 100%;
            padding: 20px;
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            box-sizing: border-box;
        }
        .add-form h3 {
            color: var(--text-color);
            margin-top: 0;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 10px;
        }
        .add-form textarea,
        .add-form select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .add-form textarea {
            min-height: 120px;
            resize: vertical;
        }
        .add-form button {
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .add-form button:first-of-type { /* N√∫t Th√™m */
            background-color: var(--success-color);
            color: white;
            margin-right: 10px;
        }
        .add-form button:last-of-type { /* N√∫t H·ªßy */
            background-color: var(--danger-color);
            color: white;
        }

        /* --- B·∫£ng D·ªØ li·ªáu --- */
        table {
            width: 100%;
            border-collapse: separate; /* S·ª≠ d·ª•ng separate ƒë·ªÉ bo g√≥c */
            border-spacing: 0;
            margin-top: 15px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden; /* C·∫ßn thi·∫øt cho bo g√≥c */
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            text-transform: uppercase;
            font-weight: 700;
            border-bottom: none;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) { /* M√†u n·ªÅn xen k·∫Ω */
            background-color: #f6f6f6;
        }
        tr:hover {
            background-color: var(--hover-bg);
        }

        /* --- √î ch·ªânh s·ª≠a tr·ª±c ti·∫øp --- */
        td[contenteditable="true"] {
            border: 1px solid transparent; /* M·∫∑c ƒë·ªãnh trong su·ªët */
            cursor: text;
        }
        td[contenteditable="true"]:hover {
            border: 1px dashed #aaa;
        }
        td[contenteditable="true"]:focus {
            border: 1px solid var(--primary-color);
            background-color: #e6f7ff; /* M√†u xanh nh·∫°t khi ƒëang s·ª≠a */
            outline: none;
        }

        /* --- Tr·∫°ng th√°i v√† Input --- */
        .status-select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-weight: 700;
        }
        .status-pending { color: orange; border-color: orange; }
        .status-in-progress { color: var(--primary-color); border-color: var(--primary-color); }
        .status-completed { color: var(--success-color); border-color: var(--success-color); }

        .time-input {
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 150px;
        }
        .delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }

        /* --- Ph√¢n trang --- */
        .pagination {
            text-align: center;
            margin-top: 25px;
        }
        .pagination button {
            padding: 10px 18px;
            margin: 0 5px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            color: #666;
        }
        .pagination span {
            margin: 0 10px;
            font-weight: 700;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h2>ƒêƒÉng nh·∫≠p H·ªá th·ªëng</h2>
        <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <p id="error-message"></p>
    </div>

    <div id="main-content">
        <header>
            <h1><span style="color: var(--success-color);">Danh s√°ch Lot</span> C·∫ßn ∆Øu Ti√™n</h1>
            <button id="logout-button" onclick="logout()">ƒêƒÉng xu·∫•t üö™</button>
        </header>

        <div class="top-controls">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo s·ªë Lot ho·∫∑c Keijo..." onkeyup="filterTable()">
            </div>
            <button class="add-button" onclick="toggleForm()">Th√™m Lot m·ªõi +</button>
        </div>

        <div class="add-form" id="addForm">
            <h3>Nh·∫≠p th√¥ng tin Lot m·ªõi</h3>
            <textarea id="newLotData" placeholder="D√°n danh s√°ch Lot, Keijo, ƒêi·ªán tr·ªü (M·ªói Lot 1 d√≤ng. V√≠ d·ª•: CKP9A0000 Z10S-UW 100)" rows="10" required></textarea>

            <select id="newProcess" required>
                <option value="">Ch·ªçn c√¥ng ƒëo·∫°n</option>
                <option value="UC">UC</option>
                <option value="C">C</option>
                <option value="R">R</option>
                <option value="T1">T1</option>
                <option value="CLF">CLF</option>
                <option value="T2">T2</option>
                <option value="T3">T3</option>
                <option value="G1">G1</option>
                <option value="GH">GH</option>
            </select>
            <button onclick="addNewLot()">Th√™m</button>
            <button onclick="toggleForm()">H·ªßy</button>
        </div>

        <table id="lotTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>S·ªë Lot</th>
                    <th>Keijo</th>
                    <th>ƒêi·ªán tr·ªü (Œ©)</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Th·ªùi gian nung xong</th>
                    <th>C√¥ng ƒëo·∫°n</th>
                    <th>DELETE</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>

        <div class="pagination">
            <button id="prevBtn" onclick="changePage(-1)" disabled>‚óÄ Tr∆∞·ªõc</button>
            <span id="pageInfo">Trang 1 / 1</span>
            <button id="nextBtn" onclick="changePage(1)">Sau ‚ñ∂</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCn866gY_3OiB_VL0fUDMe3ZCdhYDRbIJ8",
            authDomain: "lot-priority-app-shared.firebaseapp.com",
            projectId: "lot-priority-app-shared",
            storageBucket: "lot-priority-app-shared.firebasestorage.app",
            messagingSenderId: "12749059268",
            appId: "1:12749059268:web:e1aa877135d8741461c591",
            measurementId: "G-DPNT9PZ61Y"
        };

        // --- C·∫§U H√åNH DISCORD WEBHOOK ---
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1377130413708808272/BH7cEuL4lWI6C-FfhNGnl84kgZ_LnqWn8TVIY8uuesT69PzrXuxZ60Uv4Tm1TFMW9BdC";

        // Kh·ªüi t·∫°o Firebase v√† c√°c d·ªãch v·ª•
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const lotsCollection = db.collection('lots');

        // --- C√ÅC BI·∫æN TO√ÄN C·ª§C ---
        let currentPage = 1;
        const rowsPerPage = 10;
        let allRowsData = [];
        let filteredRowsData = [];
        let lotCheckerInterval; // Bi·∫øn l∆∞u tr·ªØ Interval

        // --- C√ÅC H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P FIREBASE AUTH ---

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = '';

            if (!username || !password) {
                errorMessage.textContent = 'Vui l√≤ng nh·∫≠p T√™n ƒëƒÉng nh·∫≠p v√† M·∫≠t kh·∫©u.';
                return;
            }

            const loginEmail = `${username}@lot-priority-app-shared.com`;

            try {
                await auth.signInWithEmailAndPassword(loginEmail, password);
            } catch (error) {
                console.error("L·ªói ƒëƒÉng nh·∫≠p:", error.message);
                errorMessage.textContent = 'L·ªói: T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng ki·ªÉm tra l·∫°i.';
            }
        }

        function logout() {
            auth.signOut();
            // D·ª´ng Interval khi ƒëƒÉng xu·∫•t
            if (lotCheckerInterval) {
                clearInterval(lotCheckerInterval);
                lotCheckerInterval = null;
            }
        }

        // Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p c·ªßa Firebase
        auth.onAuthStateChanged(user => {
            const loginContainer = document.getElementById('login-container');
            const mainContent = document.getElementById('main-content');

            if (user) {
                loginContainer.style.display = 'none';
                mainContent.style.display = 'block';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';

                // L·∫Øng nghe d·ªØ li·ªáu realtime t·ª´ Firestore
                listenForLots();

                // B·∫ÆT ƒê·∫¶U CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG KI·ªÇM TRA M·ªñI PH√öT
                if (!lotCheckerInterval) {
                    lotCheckerInterval = setInterval(checkAndCompleteLots, 120000); // Ch·∫°y m·ªói 60 gi√¢y (1 ph√∫t)
                    console.log("B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông ki·ªÉm tra Lot.");
                }
            } else {
                loginContainer.style.display = 'block';
                mainContent.style.display = 'none';
                document.getElementById('error-message').textContent = '';

                // D·ª´ng Interval khi ƒëƒÉng xu·∫•t
                if (lotCheckerInterval) {
                    clearInterval(lotCheckerInterval);
                    lotCheckerInterval = null;
                    console.log("ƒê√£ d·ª´ng t·ª± ƒë·ªông ki·ªÉm tra Lot.");
                }
            }
        });

        // --- H√ÄM T·ª∞ ƒê·ªòNG KI·ªÇM TRA V√Ä C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI (M·ªöI) ---
        async function checkAndCompleteLots() {
            // L·∫•y th·ªùi gian hi·ªán t·∫°i
            const now = new Date();
            let completedCount = 0;

            // L·ªçc c√°c Lot c√≥ tr·∫°ng th√°i 'ƒêang nung' V√Ä c√≥ th·ªùi gian nung xong
            const runningLots = allRowsData.filter(lot => lot.status === 'ƒêang nung' && lot.time);

            const batch = db.batch();

            runningLots.forEach(lot => {
                // Chuy·ªÉn th·ªùi gian nung xong t·ª´ chu·ªói datetime-local sang ƒë·ªëi t∆∞·ª£ng Date
                const finishTime = new Date(lot.time);

                // So s√°nh: N·∫øu th·ªùi gian nung xong <= th·ªùi gian hi·ªán t·∫°i
                if (finishTime <= now) {
                    const lotRef = lotsCollection.doc(lot.id);
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh "Ho√†n th√†nh"
                    batch.update(lotRef, {
                        status: 'Ho√†n th√†nh'
                    });
                    completedCount++;
                }
            });

            if (completedCount > 0) {
                try {
                    await batch.commit();
                    console.log(`T·ª± ƒë·ªông ho√†n th√†nh ${completedCount} Lot.`);
                    // Listener s·∫Ω t·ª± ƒë·ªông t·∫£i l·∫°i d·ªØ li·ªáu v√† giao di·ªán
                } catch (error) {
                    console.error("L·ªói khi t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i Lot:", error);
                }
            }
        }

        // --- H√ÄM G·ª¨I TH√îNG B√ÅO DISCORD ---
        async function sendDiscordNotification(count, newProcess) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL.includes("YOUR_WEBHOOK_ID")) {
                console.warn("L∆ØU √ù: Webhook URL ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t ho·∫∑c kh√¥ng h·ª£p l·ªá. Kh√¥ng th·ªÉ g·ª≠i th√¥ng b√°o Discord.");
                return;
            }

            const payload = {
                username: "H·ªá th·ªëng ∆Øu ti√™n Nung",
                content: `üîî C·∫¢NH B√ÅO: C√ì ${count} LOT H√ÄNG M·ªöI C·∫¶N ∆ØU TI√äN NUNG ·ªü c√¥ng ƒëo·∫°n **${newProcess}**! üîî`
            };

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    console.log("G·ª≠i th√¥ng b√°o Discord th√†nh c√¥ng.");
                } else {
                    console.error("L·ªói khi g·ª≠i th√¥ng b√°o Discord:", response.status, response.statusText);
                }

            } catch (error) {
                console.error("L·ªói k·∫øt n·ªëi khi g·ª≠i th√¥ng b√°o Discord:", error);
            }
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù FIRESTORE (CRUD & Realtime) V√Ä HI·ªÇN TH·ªä ---

        function getSortOrder(status) {
            if (status === 'ƒêang nung') return 0;
            if (status === 'Ch·ªù x·ª≠ l√Ω') return 1;
            return 2;
        }

        function sortLotsData(data) {
            return data.sort((a, b) => {
                const sortOrderA = getSortOrder(a.status);
                const sortOrderB = getSortOrder(b.status);

                if (sortOrderA !== sortOrderB) {
                    return sortOrderA - sortOrderB;
                }

                if (a.time && b.time) {
                    const timeA = new Date(a.time).getTime();
                    const timeB = new Date(b.time).getTime();

                    if (sortOrderA < 2) {
                        return timeA - timeB;
                    }
                    return timeB - timeA;
                }

                const createdAtA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const createdAtB = b.createdAt ? b.createdAt.toDate().getTime() : 0;

                return createdAtB - createdAtA;
            });
        }

        function listenForLots() {
            lotsCollection.onSnapshot(snapshot => {
                const lots = [];
                snapshot.forEach(doc => {
                    lots.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allRowsData = sortLotsData(lots);
                filterTable(true);
            }, error => {
                console.error("L·ªói khi l·∫Øng nghe Firestore:", error);
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Lot. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
            });
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            const totalPages = Math.ceil(filteredRowsData.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            const rowsToDisplay = filteredRowsData.slice(start, end);

            const defaultStatusClass = {
                'Ch·ªù x·ª≠ l√Ω': 'status-pending',
                'ƒêang nung': 'status-in-progress',
                'Ho√†n th√†nh': 'status-completed'
            };

            rowsToDisplay.forEach((data, index) => {
                const newRow = document.createElement('tr');
                tableBody.appendChild(newRow);

                const statusClass = defaultStatusClass[data.status] || 'status-pending';

                newRow.innerHTML = `
                    <td>${start + index + 1}</td>
                    <td contenteditable="true" data-type="lot" data-id="${data.id}">${data.lot}</td>
                    <td contenteditable="true" data-type="keijo" data-id="${data.id}">${data.keijo}</td>
                    <td contenteditable="true" data-type="resistance" data-id="${data.id}">${data.resistance}</td>
                    <td>
                        <select class="status-select ${statusClass}" onchange="changeStatus(this, '${data.id}')">
                            <option value="Ch·ªù x·ª≠ l√Ω" ${data.status === 'Ch·ªù x·ª≠ l√Ω' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                            <option value="ƒêang nung" ${data.status === 'ƒêang nung' ? 'selected' : ''}>ƒêang nung</option>
                            <option value="Ho√†n th√†nh" ${data.status === 'Ho√†n th√†nh' ? 'selected' : ''}>Ho√†n th√†nh</option>
                        </select>
                    </td>
                    <td><input type="datetime-local" class="time-input" value="${data.time || ''}" onchange="updateLotField(this, 'time', '${data.id}')"></td>
                    <td contenteditable="true" data-type="process" data-id="${data.id}">${data.process}</td>
                    <td><button class="delete-btn" onclick="deleteLot('${data.id}')">X√≥a</button></td>
                `;

                const editableCells = newRow.querySelectorAll('td[contenteditable="true"]');
                editableCells.forEach(cell => {
                    cell.addEventListener('blur', () => {
                        const field = cell.dataset.type;
                        const newValue = cell.textContent;
                        updateLotField(cell, field, data.id, newValue);
                    });
                });
            });

            document.getElementById('pageInfo').textContent = `Trang ${currentPage} / ${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 1 || totalPages <= 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages <= 1;
        }

        async function updateLotField(element, field, id, value = element.value) {
            try {
                const updatedValue = (field === 'lot') ? String(value).toUpperCase() : value;

                await lotsCollection.doc(id).update({
                    [field]: updatedValue
                });
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t Firestore:", error);
                alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu.");
            }
        }

        async function changeStatus(selectElement, id) {
            const newStatus = selectElement.value;
            updateStatusClass(selectElement, newStatus);

            const row = selectElement.closest('tr');
            const timeInput = row.cells[5].querySelector('.time-input');
            let timeValue = timeInput.value;

            // T·ª± ƒë·ªông t√≠nh th·ªùi gian nung n·∫øu chuy·ªÉn sang 'ƒêang nung' v√† ch∆∞a c√≥ th·ªùi gian
            if (newStatus === 'ƒêang nung' && !timeValue) {
                timeValue = calculateFinishTime();
            }

            try {
                await lotsCollection.doc(id).update({
                    status: newStatus,
                    time: timeValue
                });
            } catch (error) {
                console.error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:", error);
                alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i Lot.");
            }
        }

        async function addNewLot() {
            const lotData = document.getElementById('newLotData').value;
            const newProcess = document.getElementById('newProcess').value;

            if (!lotData || !newProcess) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·ªß d·ªØ li·ªáu Lot (Lot, Keijo, ƒêi·ªán tr·ªü) v√† ch·ªçn C√¥ng ƒëo·∫°n!');
                return;
            }

            const lines = lotData.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const batch = db.batch();

            let count = 0;
            lines.forEach(line => {
                const columns = line.split(/\s+/).filter(col => col.length > 0);

                if (columns.length >= 3) {
                    const lot = columns[0].toUpperCase();
                    const keijo = columns[1];
                    const resistance = columns[2];

                    const newLotRef = lotsCollection.doc();

                    batch.set(newLotRef, {
                        lot: lot,
                        keijo: keijo,
                        resistance: resistance,
                        status: 'Ch·ªù x·ª≠ l√Ω',
                        time: '',
                        process: newProcess,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    count++;
                }
            });

            if (count === 0) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu Lot h·ª£p l·ªá (Lot, Keijo, ƒêi·ªán tr·ªü). Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng!');
                return;
            }

            try {
                await batch.commit();

                sendDiscordNotification(count, newProcess);

                toggleForm();
                alert(`Th√™m th√†nh c√¥ng ${count} Lot m·ªõi!`);
            } catch (error) {
                console.error("L·ªói khi th√™m Lot v√†o Firestore:", error);
                alert("Kh√¥ng th·ªÉ th√™m Lot m·ªõi. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        async function deleteLot(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a Lot n√†y kh√¥ng?')) return;

            try {
                await lotsCollection.doc(id).delete();
            } catch (error) {
                console.error("L·ªói khi x√≥a Lot:", error);
                alert("Kh√¥ng th·ªÉ x√≥a Lot. Vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        function calculateFinishTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 105); // C·ªông 105 ph√∫t (1h45')
            const pad = (num) => (num < 10 ? '0' : '') + num;
            const year = now.getFullYear();
            const month = pad(now.getMonth() + 1);
            const day = pad(now.getDate());
            const hour = pad(now.getHours());
            const minute = pad(now.getMinutes());

            return `${year}-${month}-${day}T${hour}:${minute}`;
        }

        function updateStatusClass(selectElement, status) {
            selectElement.className = 'status-select';
            if (status === 'Ch·ªù x·ª≠ l√Ω') {
                selectElement.classList.add('status-pending');
            } else if (status === 'ƒêang nung') {
                selectElement.classList.add('status-in-progress');
            } else if (status === 'Ho√†n th√†nh') {
                selectElement.classList.add('status-completed');
            }
        }

        function filterTable(resetPage = true) {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();

            filteredRowsData = allRowsData.filter(data => {
                const lot = data.lot ? data.lot.toLowerCase() : '';
                const keijo = data.keijo ? data.keijo.toLowerCase() : '';
                return lot.includes(searchValue) || keijo.includes(searchValue);
            });

            if (resetPage) {
                currentPage = 1;
            }
            renderTable();
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredRowsData.length / rowsPerPage);
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            renderTable();
        }

        function toggleForm() {
            const form = document.getElementById('addForm');
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
            if (form.style.display === 'block') {
                document.getElementById('newLotData').value = '';
                document.getElementById('newProcess').value = '';
            }
        }

        // H√ÄM KH·ªûI T·∫†O
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>